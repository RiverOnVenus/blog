---
title: MIUI EU 设置双击电源激活智能卡崩溃
categories: [misc]
comments: true
---

太长不看：

1. 问题：MIUI EU 智能卡中设置「双击电源键唤起卡面页面」程序崩溃
2. 解决方法：把「小米智能卡」com.miui.tsmclient 转为系统应用

3. 附件：Magisk 模块 [TsmclientPatch.zip](https://drive.google.com/file/d/1-1tn_ohRvQZUVSR5IhHJ3qEr3y-C28pb/view?usp=drivesdk){:target="blank"}

> 刷任何模块之前都应该拆开看看内容，以及做好救砖的准备。这个模块会把「小米智能卡」com.miui.tsmclient 安装在  **/system/app** 目录下

在决定刷机之前，了解过 MIUI 各个版本的 ROM, 目光停留在 EEA 和 EU 之间，最后得出的结论是，在国内就用 EU, 在国外就用 EEA, 这是个人看法。

刷了 EU 过后还没有马上用过 NFC 相关的功能，后来在用门禁时，打算把门禁复刻到手机上。EU 没有相关的包，需要自己下载安装「钱包」和「小米智能卡」。安装完后复刻门禁就能用。

用的时候发现每次进入「卡」的界面就会弹出一个窗口，内容大致为，“系统已经设置了双击电源激活智能卡的快捷方式，可以在系统设置中进行更改······”，具体内容记不清了。但是没有设置成功，在「钱包」->设置->智能卡设置下可以看到其开关处于关闭状态，手动去打开会导致「小米智能卡」崩溃，且不会设置成功。

最开始想着眼不见心不烦，把这个弹窗干掉。于是用 app 把「小米智能卡」里面 **Double Click Activity** 和 **Double Press Power GuideActivity** 干掉了。这样达到的效果是：在锁屏黑屏状态下刷 NFC 时不会有任何弹窗和提示，只有 NFC 刷卡时的声音。在解锁状态刷卡时会有一个崩溃的弹窗。

这样暂时解决了弹窗问题。但是由「钱包」创建的快捷方式点击也不会有任何反应。

后来在网上发现有人用 Magisk 模块的方式把「钱包」这一套作为系统应用安装在 **/system/app** 下达到在国内刷国外的 ROM 使用 MIUI「钱包」相关功能。

「钱包」这一套指的是：

- 钱包 - com.mipay.wallet
- 小米智能卡 - com.miui.tsmclient
- 小米智能卡网页组件 - com.miui.nextpay

如果用银联相关功能还要有：

- 银联可信服务安全组件小米版本 - com.unionpay.tsmservice.mi

于是包着试一试的心态只把「小米智能卡」用模块的方式安装为系统应用，双击电源激活智能卡没有任何问题。安装为系统应用有两种方法，一种是直接把其制作为模块，另一种是利用一些工具转为系统应用，第二种本质也是模块的方式。NFC 里现在有三张卡，交通卡，门卡和 Mi Pay 绑定的银行卡。前面两者使用起来一切正常和国内 ROM 没有区别，Mi Pay 给交通卡充值也没问题，还没试过刷 Mi Pay 的 NFC，理论上也不会有问题。
