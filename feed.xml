<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="https://zhui.dev/feed.xml" rel="self" type="application/atom+xml" /><link href="https://zhui.dev/" rel="alternate" type="text/html" /><updated>2025-08-17T11:22:18+08:00</updated><id>https://zhui.dev/feed.xml</id><title type="html">Error: ä½ å‘ç°äº†ä¸€ä¸ªé”™è¯¯ï¼</title><subtitle>Life often requires some excitement, joy, and anticipation.</subtitle><author><name>Mr. Error è¿½ ğŸ§</name><email>error@zhui.dev</email></author><entry><title type="html">åœ¨å¤ç° GPU bug æ—¶ï¼Œè§¦å‘äº† Btrfs bug</title><link href="https://zhui.dev/2025-06/trigger-a-btrfs-bug-while-reproducing-a-gpu-bug.html" rel="alternate" type="text/html" title="åœ¨å¤ç° GPU bug æ—¶ï¼Œè§¦å‘äº† Btrfs bug" /><published>2025-06-28T00:00:00+08:00</published><updated>2025-06-28T00:00:00+08:00</updated><id>https://zhui.dev/2025-06/trigger-a-btrfs-bug-while-reproducing-a-gpu-bug</id><content type="html" xml:base="https://zhui.dev/2025-06/trigger-a-btrfs-bug-while-reproducing-a-gpu-bug.html"><![CDATA[<ul id="markdown-toc">
  <li><a href="#èµ·å› " id="markdown-toc-èµ·å› ">èµ·å› </a></li>
  <li><a href="#ç»è¿‡" id="markdown-toc-ç»è¿‡">ç»è¿‡</a></li>
  <li><a href="#ç¼˜ç”±" id="markdown-toc-ç¼˜ç”±">ç¼˜ç”±</a></li>
  <li><a href="#ç»“æŸ" id="markdown-toc-ç»“æŸ">ç»“æŸ</a></li>
</ul>
<h2 id="èµ·å› ">èµ·å› </h2>

<p>è¿™æ¬¡ç®—æ˜¯è¿æ°”ä¸å¥½ï¼Œå¾—è®°ä¸€ä¸‹ã€‚èµ·å› æ˜¯æ›´æ–°äº† linux-firmware-amdgpu 20250613.12fe085f-6ï¼Œé‡å¯åé»‘å±ã€‚å› ä¸ºæœ‰ amdgpu å›ºä»¶æ›´æ–°ï¼Œæ€€ç–‘æ˜¯ç‹¬æ˜¾è¾“å‡ºçš„é—®é¢˜ï¼Œäºæ˜¯æŠŠ DP çº¿æ‹”äº†ï¼Œæ¢æˆäº† HDMIï¼Œæœç„¶æ­£å¸¸è¿›å…¥æ¡Œé¢ã€‚æƒ³ç€å¤ç°ç¡®è®¤ä¸€ä¸‹ï¼ŒåˆæŠŠ DP æ¥å›å»ã€‚å½“çœ‹åˆ°è¿™æ¬¡å¼€æœºä¸æ˜¯é»‘å±ï¼Œè€Œæ˜¯è¢«æ‰”åˆ° emergency shell æ—¶ï¼Œæˆ‘æ„è¯†åˆ°ä¸å¯¹åŠ²ã€‚</p>

<h2 id="ç»è¿‡">ç»è¿‡</h2>

<p>é¦–å…ˆæ˜ å…¥çœ¼å¸˜çš„æ˜¯ä¸€äº› kp ä¿¡æ¯ï¼Œåé¢ç´§è·Ÿç€ 2 ä¸ª error, ä¸€ä¸ªæ˜¯ / æŒ‚è½½ä¸ä¸Šï¼Œä¸€ä¸ªæ˜¯ amdgpu drm errorï¼Œåè€…åŸæœ¬ä¸´æ—¶é™çº§å°±è¡Œï¼Œä½†ç°åœ¨åªèƒ½è¿› live çœ‹ä¸‹ / ä¸ºä»€ä¹ˆæŒ‚è½½ä¸ä¸Šã€‚</p>

<figure class="fancy-figure">
  <a data-fancybox="rescue" href="https://image.zhui.dev/file/1751176716020_kp.jpg">
    <img src="https://image.zhui.dev/file/1751176716020_kp.jpg" alt="Kernel Panic" />
  </a>
  <figcaption>Kernel Panic</figcaption>
</figure>

<p>è¿›å…¥ live åæ‰‹åŠ¨æŒ‚è½½ /ï¼Œä»ç„¶æ— æ³•æŒ‚è½½ï¼Œç”¨ journalctl -k â€“grep=BRTFS å¯ä»¥çœ‹åˆ°æœ‰ open_ctree failed.</p>

<figure class="fancy-figure">
  <a data-fancybox="rescue" href="https://image.zhui.dev/file/1751177521997_btrfs-error-01.jpg">
    <img src="https://image.zhui.dev/file/1751177521997_btrfs-error-01.jpg" alt="journalctl -k --grep=BRTFS" />
  </a>
  <figcaption>journalctl -k --grep=BRTFS</figcaption>
</figure>
<p>btrfs check çœ‹èµ·æ¥æ˜¯æ­£å¸¸çš„ã€‚</p>

<figure class="fancy-figure">
  <a data-fancybox="rescue" href="https://image.zhui.dev/file/1751178066902_btrfs-check.jpg">
    <img src="https://image.zhui.dev/file/1751178066902_btrfs-check.jpg" alt="btrfs check" />
  </a>
  <figcaption>btrfs check</figcaption>
</figure>

<p>è™½ç„¶ç½‘ä¸Šæœåˆ°äº†ä¸€äº›ç›¸å…³æ¡ˆä¾‹å’Œè§£å†³æ–¹æ³•ï¼Œä½†ä½œä¸º btrfs æ–°æ‰‹çš„æˆ‘æ²¡æœ‰è´¸ç„¶å°è¯•ï¼Œæ€•æŠŠç°åœºå¼„å¾—æ›´ç³Ÿç³•ï¼Œäºæ˜¯åœ¨ç¾¤é‡Œé—®äº†ä¸‹ï¼Œç¾¤å‹è®©ç»™å®Œæ•´çš„ logï¼Œä¸è¦è¿‡æ»¤ã€‚</p>

<figure class="fancy-figure">
  <a data-fancybox="rescue" href="https://image.zhui.dev/file/1751177973461_btrfs-error-02.jpg">
    <img src="https://image.zhui.dev/file/1751177973461_btrfs-error-02.jpg" alt="journalctl -k" />
  </a>
  <figcaption>journalctl -k</figcaption>
</figure>

<figure class="fancy-figure">
  <a data-fancybox="rescue" href="https://image.zhui.dev/file/1751177973365_btrfs-error-03.jpg">
    <img src="https://image.zhui.dev/file/1751177973365_btrfs-error-03.jpg" alt="journalctl -k" />
  </a>
  <figcaption>journalctl -k</figcaption>
</figure>
<p>ç»è¿‡ä¸€äº›å°è¯•æœªæœåï¼Œæœ‰ç¾¤å‹æŒ‡å‡ºé—®é¢˜å‡ºåœ¨ replay log çš„è¿‡ç¨‹ä¸­ï¼Œæ‰€ä»¥å®åœ¨ä¸è¡Œå¯ä»¥å°è¯• zero log.</p>

<p>åœ¨<code class="language-plaintext highlighter-rouge">sudo btrfs rescue zero-log /dev/nvme0n1p2</code>åæœç„¶å¯ä»¥æŒ‚è½½äº†ã€‚è¿› live åé™çº§ amdgpu å›ºä»¶ï¼Œé»‘å±ä¹Ÿä¸´æ—¶è§£å†³äº†ã€‚æœ€åç¡®è®¤äº†ç£ç›˜ check, scrub éƒ½æ²¡é—®é¢˜ã€‚</p>

<h2 id="ç¼˜ç”±">ç¼˜ç”±</h2>

<p>æ›´æ–°å›ºä»¶åé‡å¯é»‘å±çš„åŸå› æ˜¯ï¼Œarch ä¸Š backport äº†è¿™ç¬” <a href="https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git/commit/?id=a26e413e7481d12ab5a53f77e0cdde2d5be937d8">commit</a>, rx 9000 ç³»åˆ—çš„æ˜¾å¡ä¼šæœ‰å½±å“ï¼Œç°åœ¨å·²ç»ä¿®å¤äº†ã€‚</p>

<p>è¢«æ‰”åˆ° emergency shell çš„åŸå› æ˜¯è§¦å‘äº† btrfs log replay bugï¼Œå¯¼è‡´ / æŒ‚è½½ä¸ä¸Šã€‚zero log å¯è§£å†³ï¼Œè¿™æ˜¯åæ¥çœ‹åˆ°è¿™å‡ å¤©æœ‰å…¶ä»–ç¾¤å‹ä¹Ÿé‡åˆ°ç›¸åŒé—®é¢˜ï¼Œä»¥åŠçœ‹åˆ°è¿™ç¬”ä¿®å¤ <a href="https://github.com/torvalds/linux/commit/2dcf838cf5c2f0f4501edaa1680fcad03618d760">commit </a>æ‰ç¡®è®¤çš„ã€‚åœ¨ v6.15.4-arch2 ä¸­ä¹Ÿä¿®å¤äº†ã€‚</p>

<h2 id="ç»“æŸ">ç»“æŸ</h2>

<p>äº‹åå›é¡¾è¿™æ¬¡é—®é¢˜æ—¶ï¼Œå‘ç°åœ¨ btrfs æ–‡æ¡£é‡Œæœ‰æåˆ°ï¼š</p>

<blockquote>
  <p>One can determine whether <strong>zero-log</strong> is needed according to the kernel backtrace:</p>

  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>? replay_one_dir_item+0xb5/0xb5 [btrfs]
? walk_log_tree+0x9c/0x19d [btrfs]
? btrfs_read_fs_root_no_radix+0x169/0x1a1 [btrfs]
? btrfs_recover_log_trees+0x195/0x29c [btrfs]
? replay_one_dir_item+0xb5/0xb5 [btrfs]
? btree_read_extent_buffer_pages+0x76/0xbc [btrfs]
? open_ctree+0xff6/0x132c [btrfs]
</code></pre></div>  </div>

  <p>If the errors are like above, then <strong>zero-log</strong> should be used to clear the log and the filesystem may be mounted normally again. The keywords to look for are â€˜open_ctreeâ€™ which says that itâ€™s during mount and function names that contain <em>replay</em>, <em>recover</em> or <em>log_tree</em>.</p>
</blockquote>

<p>è¿˜æ˜¯å¾—å¤šçœ‹æ–‡æ¡£å•Šã€‚</p>]]></content><author><name>Mr. Error è¿½ ğŸ§</name><email>error@zhui.dev</email></author><category term="linux" /><category term="btrfs" /><category term="amd" /><summary type="html"><![CDATA[èµ·å›  ç»è¿‡ ç¼˜ç”± ç»“æŸ èµ·å› ]]></summary></entry><entry><title type="html">ç³»ç»Ÿï¼šä½ å¯¹æˆ‘åšäº†ä»€ä¹ˆï¼Ÿï¼</title><link href="https://zhui.dev/2025-03/system-log.html" rel="alternate" type="text/html" title="ç³»ç»Ÿï¼šä½ å¯¹æˆ‘åšäº†ä»€ä¹ˆï¼Ÿï¼" /><published>2025-03-16T00:00:00+08:00</published><updated>2025-03-16T00:00:00+08:00</updated><id>https://zhui.dev/2025-03/system-log</id><content type="html" xml:base="https://zhui.dev/2025-03/system-log.html"><![CDATA[<p><em>æœ€åæ›´æ–°æ—¶é—´ï¼šSat Aug  9 09:32:01 AM CST 2025</em></p>

<ul id="markdown-toc">
  <li><a href="#å‰è¨€" id="markdown-toc-å‰è¨€">å‰è¨€</a></li>
  <li><a href="#æ–‡ä»¶ç³»ç»Ÿ" id="markdown-toc-æ–‡ä»¶ç³»ç»Ÿ">æ–‡ä»¶ç³»ç»Ÿ</a>    <ul>
      <li><a href="#æŒ‚è½½å‚æ•°" id="markdown-toc-æŒ‚è½½å‚æ•°">æŒ‚è½½å‚æ•°</a></li>
      <li><a href="#btrfs-ç›¸å…³" id="markdown-toc-btrfs-ç›¸å…³">btrfs ç›¸å…³</a></li>
      <li><a href="#xfs-ç›¸å…³" id="markdown-toc-xfs-ç›¸å…³">xfs ç›¸å…³</a></li>
    </ul>
  </li>
  <li><a href="#å†…å­˜ç›¸å…³" id="markdown-toc-å†…å­˜ç›¸å…³">å†…å­˜ç›¸å…³</a>    <ul>
      <li><a href="#zram" id="markdown-toc-zram">zram</a></li>
      <li><a href="#earlyoom" id="markdown-toc-earlyoom">earlyoom</a></li>
      <li><a href="#sysctl" id="markdown-toc-sysctl">sysctl</a></li>
    </ul>
  </li>
  <li><a href="#æ€§èƒ½ç›¸å…³" id="markdown-toc-æ€§èƒ½ç›¸å…³">æ€§èƒ½ç›¸å…³</a>    <ul>
      <li><a href="#ç”µæºç®¡ç†" id="markdown-toc-ç”µæºç®¡ç†">ç”µæºç®¡ç†</a></li>
      <li><a href="#æ·»åŠ -cachyos-znver4-ä»“åº“" id="markdown-toc-æ·»åŠ -cachyos-znver4-ä»“åº“">æ·»åŠ  cachyos znver4 ä»“åº“</a></li>
      <li><a href="#ç¼–è¯‘ä¼˜åŒ–" id="markdown-toc-ç¼–è¯‘ä¼˜åŒ–">ç¼–è¯‘ä¼˜åŒ–</a></li>
      <li><a href="#ananicy-cpp" id="markdown-toc-ananicy-cpp">ananicy-cpp</a></li>
      <li><a href="#proton-cachyos" id="markdown-toc-proton-cachyos">proton-cachyos</a></li>
    </ul>
  </li>
  <li><a href="#å¤‡ä»½ç›¸å…³" id="markdown-toc-å¤‡ä»½ç›¸å…³">å¤‡ä»½ç›¸å…³</a>    <ul>
      <li><a href="#snapper-é…ç½®" id="markdown-toc-snapper-é…ç½®">Snapper é…ç½®</a></li>
    </ul>
  </li>
  <li><a href="#æ‚é¡¹" id="markdown-toc-æ‚é¡¹">æ‚é¡¹</a>    <ul>
      <li><a href="#ç¦æ­¢é¼ æ ‡å”¤é†’" id="markdown-toc-ç¦æ­¢é¼ æ ‡å”¤é†’">ç¦æ­¢é¼ æ ‡å”¤é†’</a></li>
      <li><a href="#å®šæ—¶æ¸…ç†åŒ…" id="markdown-toc-å®šæ—¶æ¸…ç†åŒ…">å®šæ—¶æ¸…ç†åŒ…</a></li>
      <li><a href="#wayland-æ··æˆå™¨è®¾ç½®ä¸º-kwin" id="markdown-toc-wayland-æ··æˆå™¨è®¾ç½®ä¸º-kwin">Wayland æ··æˆå™¨è®¾ç½®ä¸º KWin</a></li>
      <li><a href="#fontconfig" id="markdown-toc-fontconfig">Fontconfig</a></li>
      <li><a href="#ç¦æ­¢-discover-æ£€æŸ¥æ›´æ–°è‡ªå¯åŠ¨" id="markdown-toc-ç¦æ­¢-discover-æ£€æŸ¥æ›´æ–°è‡ªå¯åŠ¨">ç¦æ­¢ discover æ£€æŸ¥æ›´æ–°è‡ªå¯åŠ¨</a></li>
      <li><a href="#flatpak-ç®¡ç†-steam" id="markdown-toc-flatpak-ç®¡ç†-steam">Flatpak ç®¡ç† Steam</a></li>
      <li><a href="#å†…å­˜æ¡å…‰æ±¡æŸ“" id="markdown-toc-å†…å­˜æ¡å…‰æ±¡æŸ“">å†…å­˜æ¡å…‰æ±¡æŸ“</a></li>
      <li><a href="#sudo-è¶…æ—¶è®¾ç½®" id="markdown-toc-sudo-è¶…æ—¶è®¾ç½®">sudo è¶…æ—¶è®¾ç½®</a></li>
      <li><a href="#smartdns-æ¥ç®¡-dns" id="markdown-toc-smartdns-æ¥ç®¡-dns">SmartDNS æ¥ç®¡ DNS</a></li>
    </ul>
  </li>
</ul>
<h2 id="å‰è¨€">å‰è¨€</h2>

<p>è¿‡å»åœ¨ç¬”è®°æœ¬ä¸Šç”¨ Arch å››å¹´ï¼Œé™†é™†ç»­ç»­è£…äº†ä¸€äº›ä¼˜åŒ–ç”¨çš„è½¯ä»¶ï¼Œæ”¹äº†ä¸å°‘é…ç½®æ–‡ä»¶ï¼Œä½†æ—¶é—´ä¸€é•¿æˆ‘å·²ç»å¿˜äº†éƒ½åŠ¨è¿‡å“ªäº›åœ°æ–¹ï¼Œæœ‰äº›ä¸œè¥¿å¯èƒ½æ—©å°±ä¸é€‚ç”¨äº†ã€‚</p>

<p>æ‰€ä»¥è¿™æ¬¡åœ¨æ–°è£…çš„å°å¼æœºä¸Šï¼Œæˆ‘æ‰“ç®—æŠŠæ‰€æœ‰å’Œç³»ç»Ÿä¼˜åŒ–ã€ç»´æŠ¤æœ‰å…³çš„æ“ä½œè®°å½•ä¸‹æ¥ï¼ŒåŒ…æ‹¬å®‰è£…çš„è½¯ä»¶ã€åšçš„é…ç½®ï¼Œæ–¹ä¾¿ä»¥åæŸ¥é˜…ï¼Œä¹Ÿé¿å…é‡å¤è¸©å‘ã€‚è¿™ä»½è®°å½•ä¼šæŒç»­æ›´æ–°ã€‚</p>

<h2 id="æ–‡ä»¶ç³»ç»Ÿ">æ–‡ä»¶ç³»ç»Ÿ</h2>

<p>é¦–å…ˆæ˜¯æ–‡ä»¶ç³»ç»Ÿå’Œåˆ†åŒºã€‚è¿™æ¬¡æˆ‘åœ¨ SSD ä¸Šç”¨äº† Btrfs ä½œä¸ºæ ¹æ–‡ä»¶ç³»ç»Ÿï¼ŒHDD ä¸Šç”¨äº† XFS åšæ•°æ®ç›˜ã€‚ä¹‹å‰ä¸€ç›´ç”¨çš„æ˜¯ EXT4ï¼Œå…¶å®é¦‹ Btrfs å¾ˆä¹…äº†ã€‚è™½ç„¶è¿˜æ²¡å®Œå…¨ææ˜ç™½ Btrfsï¼Œä½†é€æ˜å‹ç¼©ã€å­å·å’Œå¯¹ SSD å‹å¥½çš„ç‰¹æ€§å·²ç»è®©æˆ‘å¾ˆæ»¡æ„äº†ã€‚XFS æ”¾åœ¨ HDD ä¸Šç”¨æ¥å­˜æ•°æ®ï¼Œæ€§èƒ½ä¹Ÿä¸é”™ï¼Œæ¯”è¾ƒçœå¿ƒã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME        FSTYPE FSVER LABEL UUID                                 FSAVAIL FSUSE% MOUNTPOINTS
sda                                                                                
â””â”€sda1      xfs                6dda4ef6-5539-425b-9e17-0a374910721b    2.2T    39% /mnt/data
zram0       swap   1     zram0 81a25874-1132-4b4a-aba9-ee63778ea6f0                [SWAP]
nvme0n1                                                                            
â”œâ”€nvme0n1p1 vfat   FAT32       A4FB-3831                               1.7G    17% /boot
â””â”€nvme0n1p2 btrfs              a0b762a5-a99d-4d46-81d8-b10aa8620fa4  431.2G    53% /game
                                                                                   /home
                                                                                   /
</code></pre></div></div>

<h3 id="æŒ‚è½½å‚æ•°">æŒ‚è½½å‚æ•°</h3>

<p>é€æ˜å‹ç¼©ç­‰çº§å¾ˆéš¾æ‰¾ä¸€ä¸ªå®Œç¾çš„å¹³è¡¡ç‚¹ï¼Œå¯¹ @ @home å­å·ç”¨é»˜è®¤çš„ã€‚kernel 6.15 ä¸Š zstd æ”¯æŒè´Ÿçš„å‹ç¼©ç­‰çº§ï¼Œå¯¹ @game å­å·ç”¨äº† compress-force=zstd:-9</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># /dev/nvme0n1p2
UUID=a0b762a5-a99d-4d46-81d8-b10aa8620fa4       /               btrfs           rw,relatime,ssd,discard=async,compress=zstd:3,space_cache=v2,subvol=/@  0 0

UUID=a0b762a5-a99d-4d46-81d8-b10aa8620fa4       /home           btrfs           rw,relatime,ssd,discard=async,compress=zstd:3,space_cache=v2,subvol=/@home      0 0

UUID=a0b762a5-a99d-4d46-81d8-b10aa8620fa4       /game           btrfs           rw,relatime,ssd,discard=async,compress-force=zstd:-9,space_cache=v2,subvol=/@game       0 0

# /dev/nvme0n1p1
UUID=A4FB-3831          /boot           vfat            rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=ascii,shortname=mixed,utf8,errors=remount-ro   0 2

# /dev/sda1
UUID=6dda4ef6-5539-425b-9e17-0a374910721b       /mnt/data       xfs             rw,relatime,attr2,inode64,logbufs=8,logbsize=32k,noquota        0 2
</code></pre></div></div>

<figure class="fancy-figure">
  <a data-fancybox="disk-test" href="https://image.zhui.dev/file/nvmessd.png">
    <img src="https://image.zhui.dev/file/nvmessd.png" alt="NVMe SSD æµ‹è¯•å›¾" />
  </a>
  <figcaption>Btrfs (compress-force=zstd:3) åœ¨ NVMe SSD çš„è¯»å†™é€Ÿåº¦æµ‹è¯•</figcaption>
</figure>

<figure class="fancy-figure">
  <a data-fancybox="disk-test" href="https://image.zhui.dev/file/hdd.png">
    <img src="https://image.zhui.dev/file/hdd.png" />
  </a>
  <figcaption>XFS åœ¨ HDD çš„è¯»å†™é€Ÿåº¦æµ‹è¯•</figcaption>
</figure>

<h3 id="btrfs-ç›¸å…³">btrfs ç›¸å…³</h3>

<p>btrfs-progs</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo pacman -S btrfs-progs
</code></pre></div></div>

<p>btrfs scrub</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo systemctl enable btrfs-scrub@-.timer
sudo systemctl start btrfs-scrub@-.timer
</code></pre></div></div>

<p>btrfs-assistant</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo pacman -S btrfs-assistant
</code></pre></div></div>

<p>btrfs balance</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo btrfs balance start --bg /
sudo btrfs balance status /
</code></pre></div></div>

<p>æŸ¥çœ‹ä½¿ç”¨æƒ…å†µ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo btrfs fi us /
</code></pre></div></div>

<h3 id="xfs-ç›¸å…³">xfs ç›¸å…³</h3>

<p>xfsprogs</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo pacman -S xfsprogs
</code></pre></div></div>

<p>æ£€æŸ¥ç¢ç‰‡ç¨‹åº¦</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo xfs_db -c frag -r /dev/sda1
</code></pre></div></div>

<p>è¿›è¡Œç¢ç‰‡æ•´ç†</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo xfs_fsr /dev/sda1
</code></pre></div></div>

<p>xfs_info</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo xfs_info /mnt/data
</code></pre></div></div>

<h2 id="å†…å­˜ç›¸å…³">å†…å­˜ç›¸å…³</h2>

<h3 id="zram">zram</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo pacman -S zram-generator
</code></pre></div></div>

<p>é…ç½®åœ¨<code class="language-plaintext highlighter-rouge">/etc/systemd/zram-generator.conf</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[zram0]
zram-size = ram
compression-algorithm = lz4
</code></pre></div></div>

<p>æ·»åŠ  zswap.enabled=0 åˆ°å†…æ ¸å‚æ•°</p>

<h3 id="earlyoom">earlyoom</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo pacman -S earlyoom
sudo systemctl enable --now earlyoom
</code></pre></div></div>

<h3 id="sysctl">sysctl</h3>

<p>åœ¨<code class="language-plaintext highlighter-rouge">/etc/sysctl.d/99-sysctl.conf</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 32G Ram + Zram(lz4) + Nvme SSD

# Contains, as bytes, the number of pages at which a process which is
# generating disk writes will itself start writing out dirty data.
vm.dirty_bytes = 536870912    # 512MB

# Contains, as bytes, the number of pages at which the background kernel
# flusher threads will start writing out dirty data.
vm.dirty_background_bytes = 134217728  # 128MB

# Decreasing the virtual file system (VFS) cache parameter value
# may improve system responsiveness (default 100)
vm.vfs_cache_pressure = 50

# The sysctl swappiness parameter determines the kernel's preference for pushing anonymous pages or page cache to disk in memory-starved situations.
# A low value causes the kernel to prefer freeing up open files (page cache), a high value causes the kernel to try to use swap space,
# For in-memory swap, like zram or zswap, as well as hybrid setups that have swap on faster devices than the filesystem, values beyond 100 can be considered.
vm.swappiness = 150

# page-cluster controls the number of pages up to which consecutive pages are read in from swap in a single attempt.
# This is the swap counterpart to page cache readahead. The mentioned consecutivity is not in terms of virtual/physical addresses,
# but consecutive on swap space - that means they were swapped out together. (Default is 3)
# increase this value to 1 or 2 if you are using physical swap (1 if ssd, 2 if hdd)
vm.page-cluster = 0
</code></pre></div></div>

<h2 id="æ€§èƒ½ç›¸å…³">æ€§èƒ½ç›¸å…³</h2>

<h3 id="ç”µæºç®¡ç†">ç”µæºç®¡ç†</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo pacman -S profile-sync-daemon
sudo systemctl enable --now power-profiles-daemon.service
</code></pre></div></div>

<h3 id="æ·»åŠ -cachyos-znver4-ä»“åº“">æ·»åŠ  cachyos znver4 ä»“åº“</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[cachyos-znver4]
Include = /etc/pacman.d/cachyos-v4-mirrorlist

[cachyos-core-znver4]
Include = /etc/pacman.d/cachyos-v4-mirrorlist

[cachyos-extra-znver4]
Include = /etc/pacman.d/cachyos-v4-mirrorlist

[core]
Include = /etc/pacman.d/mirrorlist

[extra]
Include = /etc/pacman.d/mirrorlist

[multilib]
Include = /etc/pacman.d/mirrorlist

[archlinuxcn]
Include = /etc/pacman.d/archlinuxcn-mirrorlist

[arch4edu]
Server = https://mirrors.tuna.tsinghua.edu.cn/arch4edu/$arch

[chaotic-aur]
Include = /etc/pacman.d/chaotic-mirrorlist
</code></pre></div></div>

<h3 id="ç¼–è¯‘ä¼˜åŒ–">ç¼–è¯‘ä¼˜åŒ–</h3>

<p>é…ç½®äº†<code class="language-plaintext highlighter-rouge">~/.makepkg.conf</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CFLAGS="-march=native -mtune=native -O2 -pipe -fno-plt -fexceptions \
        -Wp,-D_FORTIFY_SOURCE=3 -Wformat -Werror=format-security \
        -fstack-clash-protection -fcf-protection \
        -fno-omit-frame-pointer -mno-omit-leaf-frame-pointer"
CXXFLAGS="$CFLAGS -Wp,-D_GLIBCXX_ASSERTIONS"
RUSTFLAGS="-C opt-level=3 -C target-cpu=native -C link-arg=-z -C link-arg=pack-relative-relocs"
MAKEFLAGS="-j$(nproc) -l$(nproc)"
</code></pre></div></div>

<h3 id="ananicy-cpp">ananicy-cpp</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo pacman -S ananicy-cpp cachyos-ananicy-rules-git
systemctl enable --now ananicy-cpp.service
</code></pre></div></div>

<h3 id="proton-cachyos">proton-cachyos</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo pacman -S proton-cachyos
</code></pre></div></div>

<h2 id="å¤‡ä»½ç›¸å…³">å¤‡ä»½ç›¸å…³</h2>

<h3 id="snapper-é…ç½®">Snapper é…ç½®</h3>

<p>@ @home é…ç½®ä¸€è‡´ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># subvolume to snapshot
SUBVOLUME="/"

# filesystem type
FSTYPE="btrfs"


# btrfs qgroup for space aware cleanup algorithms
QGROUP=""


# fraction or absolute size of the filesystems space the snapshots may use
SPACE_LIMIT="0.2"

# fraction or absolute size of the filesystems space that should be free
FREE_LIMIT="0.3"


# users and groups allowed to work with config
ALLOW_USERS="zhui"
ALLOW_GROUPS=""

# sync users and groups from ALLOW_USERS and ALLOW_GROUPS to .snapshots
# directory
SYNC_ACL="no"


# start comparing pre- and post-snapshot in background after creating
# post-snapshot
BACKGROUND_COMPARISON="yes"


# run daily number cleanup
NUMBER_CLEANUP="yes"

# limit for number cleanup
NUMBER_MIN_AGE="3600"
NUMBER_LIMIT="3"
NUMBER_LIMIT_IMPORTANT="1"


# create hourly snapshots
TIMELINE_CREATE="yes"

# cleanup hourly snapshots after some time
TIMELINE_CLEANUP="yes"

# limits for timeline cleanup
TIMELINE_MIN_AGE="1800"
TIMELINE_LIMIT_HOURLY="1"
TIMELINE_LIMIT_DAILY="2"
TIMELINE_LIMIT_WEEKLY="0"
TIMELINE_LIMIT_MONTHLY="0"
TIMELINE_LIMIT_QUARTERLY="0"
TIMELINE_LIMIT_YEARLY="0"


# cleanup empty pre-post-pairs
EMPTY_PRE_POST_CLEANUP="yes"

# limits for empty pre-post-pair cleanup
EMPTY_PRE_POST_MIN_AGE="3600"
</code></pre></div></div>

<p>ç”¨ snapper-timeline.timer å’Œ snap-pac åˆ›å»ºå¿«ç…§ï¼Œé…åˆ btrfs-assistant ç®¡ç†ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo pacman -S snap-pac
sudo systemctl enable --now snapper-timeline.timer
sudo systemctl enable --now snapper-cleanup.timer
</code></pre></div></div>

<p>é™ä½å¿«ç…§åˆ›å»º/æ¸…ç†é¢‘ç‡ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo systemctl edit snapper-timeline.timer
sudo systemctl edit snapper-cleanup.timer
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>âœ cat /etc/systemd/system/snapper-timeline.timer.d/override.conf
[Timer]
OnCalendar=
OnBootSec=257m
OnUnitActiveSec=257m

âœ cat /etc/systemd/system/snapper-cleanup.timer.d/override.conf 
[Timer]
OnBootSec=
OnUnitActiveSec=
OnBootSec=10m
RandomizedDelaySec=17m
OnUnitActiveSec=1d
Persistent=true
</code></pre></div></div>

<h2 id="æ‚é¡¹">æ‚é¡¹</h2>

<h3 id="ç¦æ­¢é¼ æ ‡å”¤é†’">ç¦æ­¢é¼ æ ‡å”¤é†’</h3>

<p>ä¸ºäº†é¿å…é¼ æ ‡å”¤é†’ç³»ç»Ÿï¼Œé…ç½®äº†<code class="language-plaintext highlighter-rouge">/etc/udev/rules.d/logitech-unifying.rules</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ACTION=="add|change", SUBSYSTEM=="usb", DRIVERS=="usb", ATTRS{idVendor}=="046d", ATTRS{idProduct}=="c53f", ATTR{power/wakeup}="disabled"
</code></pre></div></div>

<h3 id="å®šæ—¶æ¸…ç†åŒ…">å®šæ—¶æ¸…ç†åŒ…</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo pacman -S pacman-contrib
sudo systemctl enable --now paccache.timer
</code></pre></div></div>

<h3 id="wayland-æ··æˆå™¨è®¾ç½®ä¸º-kwin">Wayland æ··æˆå™¨è®¾ç½®ä¸º KWin</h3>

<p>é…ç½®äº†<code class="language-plaintext highlighter-rouge">/etc/sddm.conf.d/10-wayland.conf</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[General]

DisplayServer=wayland

GreeterEnvironment=QT_WAYLAND_SHELL_INTEGRATION=layer-shell


[Wayland]

CompositorCommand=kwin_wayland --drm --no-lockscreen --no-global-shortcuts --locale1
</code></pre></div></div>

<h3 id="fontconfig">Fontconfig</h3>

<ul>
  <li>
    <p>å‚è€ƒ <a href="https://sh.alynx.one/posts/Fontconfig-NotoColorEmoji-Antialias/">Fontconfig å’Œ Noto Color Emoji å’ŒæŠ—é”¯é½¿</a></p>
  </li>
  <li>
    <p>é¢å¤–è£…äº† <a href="https://kamichikoichi.github.io/jigmo/">ttf-jigmo</a></p>
  </li>
  <li>
    <p><a href="https://web.archive.org/web/20250226125025/https://ctext.org/font-test-page/zhs">å­—ä½“è¯•éªŒé¡µ</a></p>
  </li>
</ul>

<h3 id="ç¦æ­¢-discover-æ£€æŸ¥æ›´æ–°è‡ªå¯åŠ¨">ç¦æ­¢ discover æ£€æŸ¥æ›´æ–°è‡ªå¯åŠ¨</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp /etc/xdg/autostart/org.kde.discover.notifier.desktop ~/.config/autostart/
</code></pre></div></div>

<p>æ·»åŠ  Hidden=true åˆ°æ–‡ä»¶æœ«å°¾ã€‚</p>

<h3 id="flatpak-ç®¡ç†-steam">Flatpak ç®¡ç† Steam</h3>

<p>ä¸ºäº†é¿å… steam é‡Œä¸€äº›æ¸¸æˆæ‰«ç›˜ã€åœ¨ home æ‹‰å±ï¼Œç”¨ flatpak ç®¡ç†ï¼Œé…åˆ @game å­å·è¿›è¡Œéš”ç¦»ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>flatpak --user remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
flatpak --user install flathub com.valvesoftware.Steam
</code></pre></div></div>

<h3 id="å†…å­˜æ¡å…‰æ±¡æŸ“">å†…å­˜æ¡å…‰æ±¡æŸ“</h3>

<p><a href="https://gitlab.com/CalcProgrammer1/OpenRGB">OpenRGB</a> å¯ä»¥æ‰‹åŠ¨æ§åˆ¶ï¼Œé…äº† <code class="language-plaintext highlighter-rouge">/etc/systemd/system/openrgb-sleep.service</code> ç¡çœ /å”¤é†’æ—¶è§¦å‘ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Unit]
Description=OpenRGB Sleep Control (Suspend/Resume)
Before=sleep.target
StopWhenUnneeded=true

[Service]
Type=oneshot
ExecStart=/usr/bin/openrgb --device "ENE DRAM" --mode off
ExecStopPost=/usr/bin/openrgb --device "ENE DRAM" --mode Rainbow
RemainAfterExit=yes

[Install]
WantedBy=sleep.target
</code></pre></div></div>

<h3 id="sudo-è¶…æ—¶è®¾ç½®">sudo è¶…æ—¶è®¾ç½®</h3>

<p>é»˜è®¤æ˜¯æ¯ä¸ªç»ˆç«¯éƒ½éœ€è¦è¾“å…¥å¯†ç ï¼Œä¸”è¶…æ—¶æ—¶é—´æ˜¯ 5 åˆ†é’Ÿï¼Œä¸å¤ªæ–¹ä¾¿ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">sudo visudo -f /etc/sudoers.d/99-sudo-timeout</code> å†™å…¥ä¸‹é¢ä¸¤è¡Œï¼Œ<code class="language-plaintext highlighter-rouge">sudo visudo -c</code> æ£€æŸ¥æœ‰ â€œbad permissions, should be mode 0440â€, éœ€è¦ <code class="language-plaintext highlighter-rouge">sudo chmod 0440 /etc/sudoers.d/99-sudo-timeout</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Defaults timestamp_type=global
Defaults timestamp_timeout=30
</code></pre></div></div>

<h3 id="smartdns-æ¥ç®¡-dns">SmartDNS æ¥ç®¡ DNS</h3>

<p><code class="language-plaintext highlighter-rouge">/etc/smartdns/smartdns.conf</code> é…ç½®ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bind [::]:53

force-qtype-SOA 65

conf-file /etc/smartdns/accelerated-domains.china.smartdns.conf
conf-file /etc/smartdns/apple.china.smartdns.conf
conf-file /etc/smartdns/google.china.smartdns.conf

log-level info
cache-persist yes
cache-file /tmp/smartdns.cache
prefetch-domain yes
serve-expired yes
speed-check-mode tcp:443,ping

server-https https://223.5.5.5/dns-query -bootstrap-dns -exclude-default-group
server-https https://223.6.6.6/dns-query -group china -exclude-default-group
server-https https://1.12.12.12/dns-query -group china -exclude-default-group
server-https https://120.53.53.53/dns-query -group china -exclude-default-group
server-https https://1.1.1.1/dns-query
server-https https://1.0.0.1/dns-query
server-https https://185.222.222.222/dns-query
server-https https://45.11.45.11/dns-query
server-https https://8.8.8.8/dns-query
server-https https://8.8.4.4/dns-query
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">/etc/resolv.conf</code> é…ç½®ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Managed by SmartDNS
nameserver 127.0.0.1
nameserver ::1
</code></pre></div></div>

<p>smartdns ä½œä¸º daed ä¸Šæ¸¸ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#dns
upstream {
  smartdns: 'tcp+udp://127.0.0.1:53'
}

#routing:
pname(smartdns) &amp;&amp; l4proto(udp) &amp;&amp; dport(53) -&gt; must_direct
dip(223.5.5.5, 223.6.6.6, 1.12.12.12, 120.53.53.53) -&gt; direct
dip(8.8.8.8, 8.8.4.4, 1.1.1.1, 1.0.0.1, 185.222.222.222, 45.11.45.11) -&gt; proxy
</code></pre></div></div>]]></content><author><name>Mr. Error è¿½ ğŸ§</name><email>error@zhui.dev</email></author><category term="linux" /><category term="kde" /><summary type="html"><![CDATA[æœ€åæ›´æ–°æ—¶é—´ï¼šSat Aug 9 09:32:01 AM CST 2025]]></summary></entry><entry><title type="html">SDDM ä¸»é¢˜å¯¼è‡´ç™»å½•ç¨‹åºé»‘å±</title><link href="https://zhui.dev/2024-12/login-program-black-screen-caused-by-sddm-theme.html" rel="alternate" type="text/html" title="SDDM ä¸»é¢˜å¯¼è‡´ç™»å½•ç¨‹åºé»‘å±" /><published>2024-12-15T00:00:00+08:00</published><updated>2024-12-15T00:00:00+08:00</updated><id>https://zhui.dev/2024-12/login-program-black-screen-caused-by-sddm-theme</id><content type="html" xml:base="https://zhui.dev/2024-12/login-program-black-screen-caused-by-sddm-theme.html"><![CDATA[<p>è¿™å¤©æˆ‘æ‰“å¼€ç”µè„‘å‘ç°å¼€æœºåå±å¹•é»‘å±ï¼Œåªæœ‰é¼ æ ‡å…‰æ ‡å¯è§ï¼Œç™»å½•ç•Œé¢æ²¡æœ‰æ˜¾ç¤ºã€‚çœ‹ç€å”¯ä¸€çš„å…‰æ ‡æˆ‘å¼€å§‹æ€è€ƒä¸Šæ¬¡åšäº†ä»€ä¹ˆâ€”â€”æƒ³ä¸èµ·æ¥äº†ï½</p>

<p>æˆ‘å°è¯•åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œ <code class="language-plaintext highlighter-rouge">startplasma-wayland</code>ï¼Œå‘ç°èƒ½å¤Ÿæ­£å¸¸è¿›å…¥æ¡Œé¢ã€‚è¿™è¡¨æ˜æ¡Œé¢ç¯å¢ƒæœ¬èº«æ˜¯æ­£å¸¸çš„ï¼Œé—®é¢˜å¯èƒ½å‡ºåœ¨ç™»å½•ç®¡ç†å™¨ä¸Šã€‚</p>

<p>å¼€å§‹æŸ¥çœ‹æ—¥å¿—ï¼Œå‘ç° sddm åœ¨åŠ è½½ä¸»é¢˜çš„æ—¶å€™æœ‰é—®é¢˜ã€‚</p>

<p><a data-fancybox="image" href="https://image.zhui.dev/file/1734183422289_image.png"><img src="https://image.zhui.dev/file/1734183422289_image.png" /></a></p>

<p>çœ‹äº†ä¸‹é…ç½®æ–‡ä»¶ï¼Œçš„ç¡®é…ç½®äº†ã€Œplasma-chiliã€</p>

<p><a data-fancybox="image" href="https://image.zhui.dev/file/1734183307596_image.png"><img src="https://image.zhui.dev/file/1734183307596_image.png" /></a></p>

<p>æ€è€ƒï¼Œæˆ‘ä»€ä¹ˆæ—¶å€™æŠŠã€Œå¾®é£ã€æ”¹äº†:thinking:</p>

<p>æ”¹å› Current=breeze é‡å¯ï¼Œç†Ÿæ‚‰çš„ã€Œå¾®é£ã€å›æ¥äº†ã€‚åº”è¯¥æ˜¯å› ä¸ºã€Œ<a href="http://store.kde.org/p/1214121/">plasma-chili</a>ã€æ˜¯åŸºäº plasma5 åšçš„ä¸»é¢˜ï¼Œå¯¼è‡´äº†è¿™ä¸ªé—®é¢˜ã€‚</p>]]></content><author><name>Mr. Error è¿½ ğŸ§</name><email>error@zhui.dev</email></author><category term="linux" /><category term="kde" /><summary type="html"><![CDATA[è¿™å¤©æˆ‘æ‰“å¼€ç”µè„‘å‘ç°å¼€æœºåå±å¹•é»‘å±ï¼Œåªæœ‰é¼ æ ‡å…‰æ ‡å¯è§ï¼Œç™»å½•ç•Œé¢æ²¡æœ‰æ˜¾ç¤ºã€‚çœ‹ç€å”¯ä¸€çš„å…‰æ ‡æˆ‘å¼€å§‹æ€è€ƒä¸Šæ¬¡åšäº†ä»€ä¹ˆâ€”â€”æƒ³ä¸èµ·æ¥äº†ï½]]></summary></entry><entry><title type="html">Meow~</title><link href="https://zhui.dev/2024-11/cat-photos.html" rel="alternate" type="text/html" title="Meow~" /><published>2024-11-04T00:00:00+08:00</published><updated>2024-11-04T00:00:00+08:00</updated><id>https://zhui.dev/2024-11/cat-photos</id><content type="html" xml:base="https://zhui.dev/2024-11/cat-photos.html"><![CDATA[<p><a data-fancybox="cat-photos" href="https://image.zhui.dev/file/1731074210182_1730732509302.jpg"><img src="https://image.zhui.dev/file/1731074210182_1730732509302.jpg" /></a></p>

<p><a data-fancybox="cat-photos" href="https://image.zhui.dev/file/1731074248031_1730731750717.jpg"><img src="https://image.zhui.dev/file/1731074248031_1730731750717.jpg" /></a></p>

<p><a data-fancybox="cat-photos" href="https://image.zhui.dev/file/1731074218990_1730815360985.jpg"><img src="https://image.zhui.dev/file/1731074218990_1730815360985.jpg" /></a></p>

<p><a data-fancybox="cat-photos" href="https://image.zhui.dev/file/1731074214964_1730732111768.jpg"><img src="https://image.zhui.dev/file/1731074214964_1730732111768.jpg" /></a></p>

<p><a data-fancybox="cat-photos" href="https://image.zhui.dev/file/1731074210352_1730732318365.jpg"><img src="https://image.zhui.dev/file/1731074210352_1730732318365.jpg" /></a></p>

<p><a data-fancybox="cat-photos" href="https://image.zhui.dev/file/1731074205605_1730732060880.jpg"><img src="https://image.zhui.dev/file/1731074205605_1730732060880.jpg" /></a></p>

<p><a data-fancybox="cat-photos" href="https://image.zhui.dev/file/1731074218456_1730815404970.jpg"><img src="https://image.zhui.dev/file/1731074218456_1730815404970.jpg" /></a></p>

<p><a data-fancybox="cat-photos" href="https://image.zhui.dev/file/1731074246062_1730732347519.jpg"><img src="https://image.zhui.dev/file/1731074246062_1730732347519.jpg" /></a></p>]]></content><author><name>Mr. Error è¿½ ğŸ§</name><email>error@zhui.dev</email></author><category term="gallery" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">NVIDIA å¯¼è‡´ç³»ç»ŸæŒ‚èµ·å¤±è´¥</title><link href="https://zhui.dev/2024-06/nvidia-fail-to-suspend.html" rel="alternate" type="text/html" title="NVIDIA å¯¼è‡´ç³»ç»ŸæŒ‚èµ·å¤±è´¥" /><published>2024-06-23T00:00:00+08:00</published><updated>2024-06-23T00:00:00+08:00</updated><id>https://zhui.dev/2024-06/nvidia-fail-to-suspend</id><content type="html" xml:base="https://zhui.dev/2024-06/nvidia-fail-to-suspend.html"><![CDATA[<ul id="markdown-toc">
  <li><a href="#ç°è±¡" id="markdown-toc-ç°è±¡">ç°è±¡</a></li>
  <li><a href="#æ—¥å¿—" id="markdown-toc-æ—¥å¿—">æ—¥å¿—</a></li>
  <li><a href="#è§£å†³" id="markdown-toc-è§£å†³">è§£å†³</a>    <ul>
      <li><a href="#é”™è¯¯çš„æ–¹æ³•" id="markdown-toc-é”™è¯¯çš„æ–¹æ³•">â€œé”™è¯¯çš„â€æ–¹æ³•</a></li>
      <li><a href="#æ­£ç¡®çš„æ–¹æ³•pushpin" id="markdown-toc-æ­£ç¡®çš„æ–¹æ³•pushpin">æ­£ç¡®çš„æ–¹æ³•:pushpin:</a></li>
    </ul>
  </li>
  <li><a href="#å‚è€ƒ" id="markdown-toc-å‚è€ƒ">å‚è€ƒ</a></li>
</ul>
<h2 id="ç°è±¡">ç°è±¡</h2>

<p><code class="language-plaintext highlighter-rouge">systemctl suspend</code> åç³»ç»Ÿç«‹å³è¢«å”¤é†’ã€‚</p>

<h2 id="æ—¥å¿—">æ—¥å¿—</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Jun 23 14:09:26 venus systemd[1]: Starting System Suspend...
Jun 23 14:09:26 venus systemd-sleep[2537]: User sessions remain unfrozen on explicit request ($SYSTEMD_SLEEP_FREEZE_USER_SESSIONS=0).
Jun 23 14:09:26 venus systemd-sleep[2537]: This is not recommended, and might result in unexpected behavior, particularly
Jun 23 14:09:26 venus systemd-sleep[2537]: in suspend-then-hibernate operations or setups with encrypted home directories.
Jun 23 14:09:26 venus systemd-sleep[2537]: Performing sleep operation 'suspend'...
Jun 23 14:09:28 venus systemd-sleep[2537]: Failed to put system to sleep. System resumed again: Input/output error
Jun 23 14:09:28 venus systemd[1]: systemd-suspend.service: Main process exited, code=exited, status=1/FAILURE
Jun 23 14:09:28 venus systemd[1]: systemd-suspend.service: Failed with result 'exit-code'.
Jun 23 14:09:28 venus systemd[1]: Failed to start System Suspend.
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[   95.430308] nvidia 0000:01:00.0: PM: pci_pm_suspend(): nv_pmops_suspend+0x0/0x30 [nvidia] returns -5
[   95.430918] nvidia 0000:01:00.0: PM: dpm_run_callback(): pci_pm_suspend+0x0/0x1b0 returns -5
[   95.430924] nvidia 0000:01:00.0: PM: failed to suspend async: error -5
[   97.195357] nvidia 0000:01:00.0: PM: pci_pm_suspend(): nv_pmops_suspend+0x0/0x30 [nvidia] returns -5
[   97.195930] nvidia 0000:01:00.0: PM: dpm_run_callback(): pci_pm_suspend+0x0/0x1b0 returns -5
[   97.195934] nvidia 0000:01:00.0: PM: failed to suspend async: error -5
</code></pre></div></div>

<h2 id="è§£å†³">è§£å†³</h2>

<h3 id="é”™è¯¯çš„æ–¹æ³•">â€œé”™è¯¯çš„â€æ–¹æ³•</h3>

<p>åœ¨çœ‹åˆ°æ˜¯ nvidia å¯¼è‡´çš„é—®é¢˜æ—¶ï¼Œæˆ‘ç«‹å³æƒ³çš„æ˜¯å…ˆç¦ç”¨æ‰å®ƒï¼Œäºæ˜¯å®‰è£…äº† <a href="https://github.com/bayasdev/envycontrol">envycontrol</a> åˆ‡åˆ° integrated æ¨¡å¼ï¼Œæœ‰æ•ˆã€‚</p>

<p>ä½†è¿™ä¸æ˜¯æ­£ç¡®çš„è§£å†³æ–¹æ³•ï¼Œæ‰€ä»¥å¸è½½ envycontrol å¹¶åˆ é™¤å®ƒçš„æ®‹ç•™é…ç½®æ–‡ä»¶ã€‚</p>

<h3 id="æ­£ç¡®çš„æ–¹æ³•pushpin">æ­£ç¡®çš„æ–¹æ³•:pushpin:</h3>

<p>é€šè¿‡æ—¥å¿—æ‰¾åˆ°äº† <a href="https://wiki.archlinux.org/title/Power_management/Wakeup_triggers#NVIDIA_drivers">Wakeup_triggers#NVIDIA_drivers</a>, ä¸€æ¨¡ä¸€æ ·çš„æ—¥å¿—ï¼ŒæŠ„ä¸€æŠ„ wiki çš„è§£å†³æ–¹æ³•ã€‚</p>

<p>å…ˆæ·»åŠ å†…æ ¸æ¨¡å—å‚æ•°ï¼š<code class="language-plaintext highlighter-rouge">NVreg_PreserveVideoMemoryAllocations=1</code></p>

<p>å†å¯ç”¨ç›¸å…³æœåŠ¡ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo systemctl enable nvidia-suspend.service
sudo systemctl enable nvidia-hibernate.service
sudo systemctl enable nvidia-resume.service
</code></pre></div></div>

<p>é‡å¯åæŒ‚èµ·æˆåŠŸã€‚</p>

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>

<ol>
  <li><a href="https://wiki.archlinux.org/title/Power_management/Wakeup_triggers#NVIDIA_drivers">https://wiki.archlinux.org/title/Power_management/Wakeup_triggers#NVIDIA_drivers</a></li>
  <li><a href="https://wiki.archlinux.org/title/NVIDIA/Tips_and_tricks#Preserve_video_memory_after_suspend">https://wiki.archlinux.org/title/NVIDIA/Tips_and_tricks#Preserve_video_memory_after_suspend</a></li>
</ol>]]></content><author><name>Mr. Error è¿½ ğŸ§</name><email>error@zhui.dev</email></author><category term="linux" /><category term="nvidia" /><summary type="html"><![CDATA[ç°è±¡ æ—¥å¿— è§£å†³ â€œé”™è¯¯çš„â€æ–¹æ³• æ­£ç¡®çš„æ–¹æ³•:pushpin: å‚è€ƒ ç°è±¡]]></summary></entry><entry><title type="html">TCP listen çš„æ•…äº‹</title><link href="https://zhui.dev/2024-04/tcp-listen.html" rel="alternate" type="text/html" title="TCP listen çš„æ•…äº‹" /><published>2024-04-16T00:00:00+08:00</published><updated>2024-04-16T00:00:00+08:00</updated><id>https://zhui.dev/2024-04/tcp-listen</id><content type="html" xml:base="https://zhui.dev/2024-04/tcp-listen.html"><![CDATA[<ul id="markdown-toc">
  <li><a href="#man-2-listen" id="markdown-toc-man-2-listen">man 2 listen</a></li>
  <li><a href="#ä¸¤ä¸ªé˜Ÿåˆ—å’Œä¸‰æ¬¡æ¡æ‰‹" id="markdown-toc-ä¸¤ä¸ªé˜Ÿåˆ—å’Œä¸‰æ¬¡æ¡æ‰‹">ä¸¤ä¸ªé˜Ÿåˆ—å’Œä¸‰æ¬¡æ¡æ‰‹</a>    <ul>
      <li><a href="#æµ‹è¯•ç¨‹åºå’ŒæŠ“åŒ…" id="markdown-toc-æµ‹è¯•ç¨‹åºå’ŒæŠ“åŒ…">æµ‹è¯•ç¨‹åºå’ŒæŠ“åŒ…</a></li>
    </ul>
  </li>
  <li><a href="#åè®®æ”»å‡»" id="markdown-toc-åè®®æ”»å‡»">åè®®æ”»å‡»</a>    <ul>
      <li><a href="#å¯¹ç­–" id="markdown-toc-å¯¹ç­–">å¯¹ç­–</a></li>
    </ul>
  </li>
  <li><a href="#å‚è€ƒèµ„æ–™" id="markdown-toc-å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li>
</ul>
<h2 id="man-2-listen">man 2 listen</h2>

<p>å…ˆä»æ‰‹å†Œçœ‹çœ‹æè¿°ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DESCRIPTION
       listen() marks the socket referred to by sockfd as a passive socket, that is, as a socket that will be
       used to accept incoming connection requests using accept(2).

       The  sockfd  argument  is  a  file descriptor that refers to a socket of type SOCK_STREAM or SOCK_SEQâ€
       PACKET.

       The backlog argument defines the maximum length to which the queue of pending connections  for  sockfd
       may  grow.   If  a  connection request arrives when the queue is full, the client may receive an error
       with an indication of ECONNREFUSED or, if the underlying protocol supports retransmission, the request
       may be ignored so that a later reattempt at connection succeeds.

</code></pre></div></div>

<p>ä»æè¿°ä¸­å¯ä»¥çŸ¥é“ï¼Œ<code class="language-plaintext highlighter-rouge">listen()</code> å°† <code class="language-plaintext highlighter-rouge">sockfd</code> å¼•ç”¨çš„å¥—æ¥å­—æ ‡è®°ä¸ºè¢«åŠ¨å¥—æ¥å­—ï¼Œå¯ä»¥åœ¨ä¸Šé¢è°ƒç”¨ <code class="language-plaintext highlighter-rouge">accept()</code> ã€‚</p>

<p>åœ¨åé¢çš„æ³¨æ„äº‹é¡¹ä¸­æœ‰è¿™æ ·ä¸€æ®µè¯ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NOTES
       The  behavior  of  the  backlog  argument on TCP sockets changed with Linux 2.2.  Now it specifies the
       queue length for completely established sockets waiting to be accepted, instead of the number  of  inâ€
       complete connection requests.  The maximum length of the queue for incomplete sockets can be set using
       /proc/sys/net/ipv4/tcp_max_syn_backlog.   When  syncookies  are  enabled  there  is no logical maximum
       length and this setting is ignored.  See tcp(7) for more information.

       If the backlog argument is greater than the value in /proc/sys/net/core/somaxconn, then it is silently
       capped to that value.  Since Linux 5.4, the default in this file is 4096; in earlier kernels, the  deâ€
       fault value is 128.  Before Linux 2.4.25, this limit was a hard coded value, SOMAXCONN, with the value
       128.
</code></pre></div></div>

<p>è¿™è¯´æ˜è°ƒç”¨<code class="language-plaintext highlighter-rouge">listen()</code>æ—¶å†…æ ¸ç»´æŠ¤äº†ä¸¤ä¸ªé˜Ÿåˆ— â€”â€” â€œæœªå®Œå…¨å»ºç«‹è¿æ¥é˜Ÿåˆ—â€å’Œâ€œå®Œå…¨å»ºç«‹è¿æ¥é˜Ÿåˆ—â€ï¼Œä¹Ÿå°±æ˜¯ä¸‹æ–‡ä¸­çš„ syn queue å’Œ pending queue.</p>

<p>å†å›åˆ°å‡½æ•°åŸå‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">listen</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">);</span>
</code></pre></div></div>

<p>å‚æ•° <code class="language-plaintext highlighter-rouge">sockfd</code> æ˜¯ä¸€ä¸ªå·²ç»åˆ›å»ºçš„å¥—æ¥å­—æè¿°ç¬¦ï¼Œè€Œ <code class="language-plaintext highlighter-rouge">backlog</code> åˆ™è¡¨ç¤ºæœåŠ¡å™¨ç«¯èƒ½å¤Ÿæ¥å—çš„å®Œå…¨å»ºç«‹çš„å¥—æ¥å­—è¿æ¥é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ã€‚</p>

<h2 id="ä¸¤ä¸ªé˜Ÿåˆ—å’Œä¸‰æ¬¡æ¡æ‰‹">ä¸¤ä¸ªé˜Ÿåˆ—å’Œä¸‰æ¬¡æ¡æ‰‹</h2>

<p>TCP é€šä¿¡è¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š</p>

<p><a data-fancybox="tcp-listen" href="../assets/img/post/tcp-listen/tcp-socket.png"><img src="../assets/img/post/tcp-listen/tcp-socket.png" /></a></p>

<p>ä¸‰æ¬¡æ¡æ‰‹å‘ç”Ÿåœ¨ç³»ç»Ÿè°ƒç”¨ <code class="language-plaintext highlighter-rouge">connect()</code>,<code class="language-plaintext highlighter-rouge">listen()</code>é˜¶æ®µï¼š</p>

<p><a data-fancybox="tcp-listen" href="../assets/img/post/tcp-listen/tcp-socket-3whs.png"><img src="../assets/img/post/tcp-listen/tcp-socket-3whs.png" /></a></p>

<ul>
  <li>syn queue - ç”¨äºå­˜å‚¨ SYN_RECV çŠ¶æ€çš„è¿æ¥</li>
  <li>pending queue - ç”¨äºå­˜å‚¨ ESTABLISHED çŠ¶æ€çš„è¿æ¥</li>
</ul>

<p>å®¢æˆ·ç«¯è°ƒç”¨ <code class="language-plaintext highlighter-rouge">connect()</code> å‘èµ·è¿æ¥ï¼Œå‘é€äº†ç¬¬ä¸€æ¬¡æ¡æ‰‹çš„ SYN åŒ…ï¼ŒæœåŠ¡å™¨å›äº† SYN+ACK åŒ…ï¼Œæ­¤æ—¶çš„è¿æ¥ï¼ˆSYN_RECV çŠ¶æ€ï¼‰ä¼šæ”¾åœ¨ syn queueï¼ŒæœåŠ¡å™¨æ”¶åˆ°æœ€åä¸€ä¸ª ACK åŒ…å®Œæˆä¸‰æ¬¡æ¡æ‰‹å®Œæˆåçš„è¿æ¥ï¼ˆESTABLISHED çŠ¶æ€ï¼‰æ”¾åœ¨ pending queueï¼Œç­‰å¾… <code class="language-plaintext highlighter-rouge">accept()</code> è°ƒç”¨å‡ºé˜Ÿã€‚</p>

<h3 id="æµ‹è¯•ç¨‹åºå’ŒæŠ“åŒ…">æµ‹è¯•ç¨‹åºå’ŒæŠ“åŒ…</h3>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ªéªŒè¯ TCP ä¸‰æ¬¡æ¡æ‰‹å‘ç”Ÿåœ¨<code class="language-plaintext highlighter-rouge">connect()</code>,<code class="language-plaintext highlighter-rouge">listen()</code>é˜¶æ®µçš„ç®€å•ç¤ºä¾‹ï¼š</p>

<p>client.c</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;netinet/in.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;strings.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">sockfd</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"socket"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server_addr</span><span class="p">;</span>
  <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
  <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
  <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>

  <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"connect"</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"connected</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>server.c</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;netinet/in.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;strings.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">sockfd</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"socket"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server_addr</span><span class="p">;</span>
  <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
  <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
  <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>

  <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"bind"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">ret</span> <span class="o">=</span> <span class="n">listen</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="mi">33</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"listen"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="c1">// ç•™ç»™æŠ“åŒ…çš„æ—¶é—´</span>
  <span class="n">close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>å…ˆè¿è¡Œ server</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>âœ ./server 192.168.100.191 33333
</code></pre></div></div>

<p>å†æŠ“åŒ…</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>âœ sudo tcpdump -i any port 33333
</code></pre></div></div>

<p>æœ€åç”¨ client è¿æ¥ server</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>âœ ./client 192.168.100.191 33333
</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°æŠ“åŒ…çš„è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>âœ sudo tcpdump -i any port 33333
tcpdump: data link type LINUX_SLL2
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
15:17:50.191602 lo    In  IP venus.38172 &gt; venus.dgi-serv: Flags [SEW], seq 3952710686, win 33280, options [mss 65495,nop,nop,sackOK,nop,wscale 10], length 0
15:17:50.191625 lo    In  IP venus.dgi-serv &gt; venus.38172: Flags [S.E], seq 2291194089, ack 3952710687, win 33280, options [mss 65495,nop,nop,sackOK,nop,wscale 10], length 0
15:17:50.191652 lo    In  IP venus.38172 &gt; venus.dgi-serv: Flags [.], ack 1, win 33, length 0
</code></pre></div></div>

<ol>
  <li><code class="language-plaintext highlighter-rouge">Flags [SEW]</code>: è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª SYN åŒ…ï¼ŒåŒæ—¶ ECE å’Œ CWR æ ‡å¿—ä½è¢«ç½®ä½ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">Flags [S.E]</code>: è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª SYN+ACK åŒ…ï¼ŒåŒæ—¶ ECE æ ‡å¿—è¢«ç½®ä½ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">Flags [.]</code>: è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª ACK åŒ…ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°äº†æœåŠ¡å™¨ç«¯çš„ SYN+ACK åŒ…ï¼Œå¹¶ç¡®è®¤å»ºç«‹äº†è¿æ¥ã€‚</li>
</ol>

<h2 id="åè®®æ”»å‡»">åè®®æ”»å‡»</h2>

<p>SYN æ³›æ´ªï¼Œåœ¨ DDoS ä¸­å±äº TCP åè®®æ”»å‡»ï¼Œé’ˆå¯¹çš„æ˜¯ syn queue.</p>

<h3 id="å¯¹ç­–">å¯¹ç­–</h3>

<p>å¢å¤§ syn queue æœ€å¤§é•¿åº¦ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net.ipv4.tcp_max_syn_backlog = 8192
</code></pre></div></div>

<p>ç›¸å…³é˜…è¯»ï¼š</p>

<ul>
  <li><a href="https://www.cloudflare.com/learning/ddos/syn-flood-ddos-attack/">https://www.cloudflare.com/learning/ddos/syn-flood-ddos-attack</a></li>
  <li><a href="https://zh.wikipedia.org/wiki/SYN_flood">https://zh.wikipedia.org/wiki/SYN_flood</a></li>
  <li><a href="https://wiki.archlinux.org/title/Sysctl#Tweak_the_pending_connection_handling">https://wiki.archlinux.org/title/Sysctl#Tweak_the_pending_connection_handling</a></li>
</ul>

<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>

<ol>
  <li>man 2 listen</li>
  <li><a href="https://stackoverflow.com/questions/12893379/listen-queue-length-in-socket-programing-in-c">https://stackoverflow.com/questions/12893379/listen-queue-length-in-socket-programing-in-c</a></li>
</ol>]]></content><author><name>Mr. Error è¿½ ğŸ§</name><email>error@zhui.dev</email></author><category term="network" /><summary type="html"><![CDATA[man 2 listen ä¸¤ä¸ªé˜Ÿåˆ—å’Œä¸‰æ¬¡æ¡æ‰‹ æµ‹è¯•ç¨‹åºå’ŒæŠ“åŒ… åè®®æ”»å‡» å¯¹ç­– å‚è€ƒèµ„æ–™ man 2 listen]]></summary></entry><entry><title type="html">è®°å½•ä¸€æ¬¡æŠ“ TCP ä¸‰æ¬¡æ¡æ‰‹</title><link href="https://zhui.dev/2024-03/capture-tcp-3-way-handshake.html" rel="alternate" type="text/html" title="è®°å½•ä¸€æ¬¡æŠ“ TCP ä¸‰æ¬¡æ¡æ‰‹" /><published>2024-03-16T00:00:00+08:00</published><updated>2024-03-16T00:00:00+08:00</updated><id>https://zhui.dev/2024-03/capture-tcp-3-way-handshake</id><content type="html" xml:base="https://zhui.dev/2024-03/capture-tcp-3-way-handshake.html"><![CDATA[<ul id="markdown-toc">
  <li><a href="#å‰è¨€" id="markdown-toc-å‰è¨€">å‰è¨€</a></li>
  <li><a href="#æ­£æ–‡" id="markdown-toc-æ­£æ–‡">æ­£æ–‡</a>    <ul>
      <li><a href="#ç†è®º" id="markdown-toc-ç†è®º">ç†è®º</a></li>
      <li><a href="#å®è·µ" id="markdown-toc-å®è·µ">å®è·µ</a></li>
    </ul>
  </li>
  <li><a href="#å‚è€ƒèµ„æ–™" id="markdown-toc-å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li>
</ul>
<h2 id="å‰è¨€">å‰è¨€</h2>

<p>TCP ä¸‰æ¬¡æ¡æ‰‹çœ‹è¿‡å¾ˆå¤šæ¬¡äº†ï¼Œå½“æ—¶ä¹Ÿæ˜¯ç†è§£äº†ï¼Œä½†æ˜¯æ€»æ˜¯å¿˜è®°ã€‚æ¯”å¦‚è¿™æ¬¡ï¼Œåˆå¿˜äº†ï¼Œæ‰€æœ‰æ¥æŠ“åŒ…åŠ æ·±è®°å¿†å’Œç†è§£ï¼Œè¦æ˜¯è¿˜å¿˜äº†ï¼Œå°±æ¥è¿™å„¿çœ‹çœ‹:joy:</p>

<p>æŠ“åŒ…å·¥å…·æœ¬æ¥æƒ³è¯•è¯• termshark æ¥ç€ï¼Œå› ä¸ºæ²¡ç”¨è¿‡ï¼Œä½†æ˜¯ä¸­é€”å†…å­˜æ³„æ¼è¢« earlyoom æ€æ­»äº†ï¼Œè¿˜æ˜¯ç”¨ wireshark.</p>

<p><span class="spoiler">earlyoom çš„é€šçŸ¥æ€ä¹ˆåˆå¥½äº†ï¼ˆ</span></p>

<p><a data-fancybox="capture-tcp-3-way-handshake" href="../assets/img/post/capture-tcp-3-way-handshake/system-notify.png"><img src="../assets/img/post/capture-tcp-3-way-handshake/system-notify.png" /></a></p>

<p>å¦‚æœä½ ä¹Ÿä¸å–œæ¬¢ systemd-oomd è¯•è¯• <a href="https://github.com/rfjakob/earlyoom">earlyoom</a>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>earlyoom[454]: Will avoid killing process names that match regex '(^|/)(init|systemd|Xorg|sshd)$'
earlyoom[454]: mem total: 7721 MiB, swap total: 7720 MiB
earlyoom[454]: sending SIGTERM when mem &lt;= 10.00% and swap &lt;= 10.00%,
earlyoom[454]:         SIGKILL when mem &lt;=  5.00% and swap &lt;=  5.00%
earlyoom[454]: mem avail:  7072 of  7721 MiB (91.60%), swap free: 7720 of 7720 MiB (100.00%)
earlyoom[454]: mem avail:   554 of  7721 MiB ( 7.18%), swap free:  742 of 7720 MiB ( 9.62%)
earlyoom[454]: low memory! at or below SIGTERM limits: mem 10.00%, swap 10.00%
earlyoom[454]: sending SIGTERM to process 9994 uid 1000 "termshark": badness 1181, VmRSS 4568 MiB
earlyoom[454]: escalating to SIGKILL after 2.8 seconds
earlyoom[454]: process exited after 2.8 seconds

</code></pre></div></div>

<p>å¥½åƒåé¢˜äº†ã€‚</p>

<h2 id="æ­£æ–‡">æ­£æ–‡</h2>

<h3 id="ç†è®º">ç†è®º</h3>

<p>å¼€å§‹æŠ“åŒ…ï¼ŒæŠ“å–çš„æ˜¯æœ¬åœ°è®¿é—®åšå®¢äº§ç”Ÿçš„ TCP æ•°æ®åŒ…ï¼Œä¸‹é¢çš„ NO.1343 â€“ [SYN], NO.1344 â€“ [SYN, ACK], NO.1345 â€“ [ACK] ä¸‰ä¸ªåŒ…åˆ†åˆ«å¯¹åº”ä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹ï¼Œ</p>

<p><a data-fancybox="capture-tcp-3-way-handshake" href="../assets/img/post/capture-tcp-3-way-handshake/img01.png"><img src="../assets/img/post/capture-tcp-3-way-handshake/img01.png" /></a></p>

<p>å…ˆå›å¿†ä¸€ä¸‹ TCP ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼Œç®€å•ç”»äº†ä¸ªå›¾ï¼š</p>

<p><a data-fancybox="capture-tcp-3-way-handshake" href="../assets/img/post/capture-tcp-3-way-handshake/img02.png"><img src="../assets/img/post/capture-tcp-3-way-handshake/img02.png" /></a></p>

<p>å†çœ‹çœ‹ TCP æŠ¥æ–‡æ®µå¤´éƒ¨æ ¼å¼ï¼š</p>

<p><a data-fancybox="capture-tcp-3-way-handshake" href="../assets/img/post/capture-tcp-3-way-handshake/img03.png"><img src="../assets/img/post/capture-tcp-3-way-handshake/img03.png" /></a></p>

<blockquote>
  <p>Screenshot from <a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol">Wikipedia</a></p>
</blockquote>

<p>ç»“åˆä¸Šé¢ä¸‰å¼ å›¾åˆ†æ TCP ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼Œç„¶ååˆ†ææŠ“åŒ…çš„æ•°æ®ï¼š</p>

<ol>
  <li>[SYN]ï¼šå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ª SYN åŒ…æ¥å‘èµ·ä¸»åŠ¨è¿æ¥ï¼Œå®¢æˆ·ç«¯å°†æ•°æ®åŒ…çš„åºåˆ—å· Seq è®¾ç½®ä¸ºä¸€ä¸ªéšæœºæ•° x. æ­¤æ—¶ï¼Œæ ‡å¿—ä½ SYN = 1, åºåˆ—å· Seq = x.</li>
  <li>[SYN, ACK]ï¼šæœåŠ¡å™¨å›åº”ä¸€ä¸ª [SYN, ACK] åŒ…ã€‚ç¡®è®¤å· Ack è¢«è®¾ç½®ä¸ºæ¥æ”¶åˆ°çš„åºåˆ—å·åŠ  1ï¼Œå³ x + 1ï¼ŒæœåŠ¡å™¨çš„æ•°æ®åŒ…åºåˆ—å· Seq è®¾ç½®ä¸ºå¦ä¸€ä¸ªéšæœºæ•° yã€‚æ­¤æ—¶ï¼Œæ ‡å¿—ä½ SYN = 1, æ ‡å¿—ä½ ACK = 1, ç¡®è®¤å· Ack = x + 1, åºåˆ—å· Seq = y.</li>
  <li>[ACK]ï¼šæœ€åï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ª ACK åŒ…ã€‚æ•°æ®åŒ…çš„åºåˆ—å· Seq è¢«è®¾ç½®ä¸ºæ¥æ”¶åˆ°çš„ç¡®è®¤å· Ackï¼Œå³ x + 1ï¼Œç¡®è®¤å· Ack è¢«è®¾ç½®ä¸ºæ¥æ”¶åˆ°çš„åºåˆ—å·åŠ  1ï¼Œå³ y + 1ã€‚æ­¤æ—¶ï¼Œæ ‡å¿—ä½ ACK = 1, åºåˆ—å· Seq = x + 1, ç¡®è®¤å· Ack = y + 1.</li>
</ol>

<p>ä¸ºäº†æ›´å¥½çš„ç†è§£ TCP ä¸‰æ¬¡æ¡æ‰‹ä½œä»¥ä¸‹è¡¥å……è¯´æ˜ï¼š</p>

<ul>
  <li>ACK æ ‡å¿—ä½ (Acknowledgment) å’Œ Ack ç¡®è®¤å·å­—æ®µ (Acknowledgment number) ä¸è¦æ··æ·†ã€‚åœ¨ TCP åè®®ä¸­ï¼Œâ€Acknowledgment (ACK)â€ æ˜¯ TCP æŠ¥æ–‡æ®µå¤´éƒ¨çš„ä¸€ä¸ªæ ‡å¿—ä½ï¼Œå®ƒç”¨æ¥è¡¨ç¤ºä¸€ä¸ª TCP æŠ¥æ–‡æ®µæ˜¯å¦åŒ…å«â€œç¡®è®¤â€ã€‚å½“ ACK æ ‡å¿—ä½è¢«ç½®ä¸º 1 æ—¶ï¼Œè¡¨ç¤ºè¯¥æŠ¥æ–‡æ®µç¡®è®¤äº†å·²ç»æ”¶åˆ°çš„æ•°æ®ã€‚ â€œAcknowledgment Numberâ€ æ˜¯ TCP æŠ¥æ–‡æ®µå¤´éƒ¨çš„ä¸€ä¸ªå­—æ®µï¼Œç”¨æ¥è¡¨ç¤ºå‘é€æ–¹æœŸæœ›æ¥æ”¶åˆ°çš„ä¸‹ä¸€ä¸ªåºåˆ—å·ã€‚å½“ä¸€ä¸ª TCP æŠ¥æ–‡æ®µè¢«å‘é€æ–¹è®¾ç½®äº† ACK æ ‡å¿—ä½ä¸º 1 æ—¶ï¼Œè¯¥æŠ¥æ–‡æ®µçš„ Acknowledgment Number å­—æ®µè¡¨æ˜äº†å‘é€æ–¹æœŸæœ›æ¥æ”¶åˆ°çš„ä¸‹ä¸€ä¸ªåºåˆ—å·ã€‚</li>
  <li>æŠ“åŒ…çš„æ—¶å€™å¯ä»¥çœ‹è§ Ack = 1 (Ack ç¡®è®¤å·)ï¼Œè¿™é‡Œçš„ 1 æ˜¯ç›¸å¯¹ç¡®è®¤å·ï¼Œå¯ä»¥ç†è§£ä¸ºåç§»é‡ï¼Œä¸æ˜¯çœŸæ­£çš„ç¡®è®¤å·ï¼ˆç›¸å¯¹åºåˆ—å·åŒç†ï¼‰ï¼Œä¹Ÿä¸è¦å’Œ ACK = 1 (Acknowledgment) æ··æ·†ã€‚æœ¬æ–‡ä¸­ï¼Œå…¨å¤§å†™çš„ ACK æ˜¯æ ‡å¿—ä½ï¼Œé¦–å­—æ¯å¤§å†™çš„ Ack æ˜¯ç¡®è®¤å·ã€‚</li>
  <li>ä¸‹é¢çš„ Flags: (SYN), Flags: (SYN, ACK) è¡¨ç¤ºå¯¹åº”çš„æ ‡å¿—ä½ä¸º 1.</li>
</ul>

<p>æ¥ä¸‹æ¥é€åŒ…åˆ†æ [SYN]ï¼Œ[SYN, ACK]ï¼Œ[ACK] ä¸‰ä¸ªåŒ…ä¸­çš„å„ä¸ªæ•°æ®ä¹‹é—´çš„å…³ç³»æ˜¯å¦å’Œä¸Šè¿°ä¸€è‡´ã€‚</p>

<h3 id="å®è·µ">å®è·µ</h3>

<p>ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯ 192.168.100.191 å‘é€äº†ä¸€ä¸ª [SYN] åŒ…ç»™æœåŠ¡ç«¯ 172.67.149.132ï¼Œæ­¤æ—¶ï¼ŒSeq = 0x4ce45750, Flags: (SYN).</p>

<p><a data-fancybox="capture-tcp-3-way-handshake" href="../assets/img/post/capture-tcp-3-way-handshake/img04.png"><img src="../assets/img/post/capture-tcp-3-way-handshake/img04.png" /></a></p>

<p>ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼šæœåŠ¡ç«¯ 172.67.149.132 æ”¶åˆ° [SYN] åŒ…ï¼Œå›åº”äº†ä¸€ä¸ª [SYN, ACK] åŒ…ç»™å®¢æˆ·ç«¯ 192.168.100.191ï¼Œæ­¤æ—¶ï¼ŒAck = 0x4ce45751, Seq = 0xc112f693,Flags: (SYN, ACK).</p>

<p><a data-fancybox="capture-tcp-3-way-handshake" href="../assets/img/post/capture-tcp-3-way-handshake/img05.png"><img src="../assets/img/post/capture-tcp-3-way-handshake/img05.png" /></a></p>

<p><a data-fancybox="capture-tcp-3-way-handshake" href="../assets/img/post/capture-tcp-3-way-handshake/img06.png"><img src="../assets/img/post/capture-tcp-3-way-handshake/img06.png" /></a></p>

<p>ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼šæœ€åï¼Œå®¢æˆ·ç«¯ 192.168.100.191 å›åº”ä¸€ä¸ª [ACK] åŒ…ï¼Œæ­¤æ—¶ï¼ŒAck = 0xc112f694, Seq = 0x4ce45751, Flags: (ACK).</p>

<p><a data-fancybox="capture-tcp-3-way-handshake" href="../assets/img/post/capture-tcp-3-way-handshake/img07.png"><img src="../assets/img/post/capture-tcp-3-way-handshake/img07.png" /></a></p>

<p><a data-fancybox="capture-tcp-3-way-handshake" href="../assets/img/post/capture-tcp-3-way-handshake/img08.png"><img src="../assets/img/post/capture-tcp-3-way-handshake/img08.png" /></a></p>

<p>å®¢æˆ·ç«¯æœåŠ¡å™¨å»ºç«‹è¿æ¥å®Œæˆã€‚</p>

<p>ä¹‹å‰è§è¿‡ä¸€ä¸ª TCP ç›¸å…³çš„ç¬‘è¯æ¥ç€ï¼Œæ‰¾ä¸åˆ°äº†:upside_down_face:</p>

<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>

<ol>
  <li><a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol">https://en.wikipedia.org/wiki/Transmission_Control_Protocol</a></li>
</ol>]]></content><author><name>Mr. Error è¿½ ğŸ§</name><email>error@zhui.dev</email></author><category term="network" /><summary type="html"><![CDATA[å‰è¨€ æ­£æ–‡ ç†è®º å®è·µ å‚è€ƒèµ„æ–™ å‰è¨€]]></summary></entry><entry><title type="html">å…³äºæˆ‘å–œæ¬¢ KDE6 å£çº¸è¿™ä»¶äº‹</title><link href="https://zhui.dev/2024-03/kde6-wallpapers.html" rel="alternate" type="text/html" title="å…³äºæˆ‘å–œæ¬¢ KDE6 å£çº¸è¿™ä»¶äº‹" /><published>2024-03-08T00:00:00+08:00</published><updated>2024-03-08T00:00:00+08:00</updated><id>https://zhui.dev/2024-03/kde6-wallpapers</id><content type="html" xml:base="https://zhui.dev/2024-03/kde6-wallpapers.html"><![CDATA[<p><a data-fancybox="kde6-wallpapers" href="../assets/img/post/kde6-wallpapers/screenshot-from-kde-megarelease6.png"><img src="../assets/img/post/kde6-wallpapers/screenshot-from-kde-megarelease6.png" /></a></p>

<blockquote>
  <p>Screenshot from <a href="https://kde.org/announcements/megarelease/6/">KDE MegaRelease6</a></p>
</blockquote>

<p>KDE6 æ›´æ–°äº†å¾ˆå¤šä¸œè¥¿ï¼Œæˆ‘æœ€å–œæ¬¢çš„ç«Ÿç„¶æ˜¯æ–°å¢çš„å£çº¸ã€ŒScarlet Treeã€ï¼Œå®ƒæœ‰ light å’Œ dark ä¸¤ç§é£æ ¼ï¼Œè¿˜æœ‰é€‚ç”¨äºæ‰‹æœºçš„åˆ†è¾¨ç‡ã€‚å£çº¸ä½äº<code class="language-plaintext highlighter-rouge">/usr/share/wallpapers/</code></p>

<p>å¼€å§‹æ¬£èµå£çº¸ï¼ˆåŸå›¾ï¼‰å§ï¼</p>

<blockquote>
  <p>Transform your desktop with the mesmerizing â€˜Scarlet Treeâ€™ wallpaper by axo1otl. Capture the dynamic interplay between the sunâ€™s vibrant energy and the cometâ€™s celestial dance.</p>
</blockquote>

<p><a data-fancybox="kde6-wallpapers" href="https://image.zhui.dev/file/1731154981836_5120x2880.png"><img src="https://image.zhui.dev/file/1731154981836_5120x2880.png" /></a></p>

<p><a data-fancybox="kde6-wallpapers" href="https://image.zhui.dev/file/1731154973483_5120x2880.png"><img src="https://image.zhui.dev/file/1731154973483_5120x2880.png" /></a></p>

<p>6.1 æ›´æ–°çš„ã€ŒReefã€ï¼Œè¿™ç§é£æ ¼çš„å£çº¸å¤ªå–œæ¬¢äº†ã€‚</p>

<p><a data-fancybox="kde6-wallpapers" href="https://image.zhui.dev/file/1731155190919_Reef.jpg"><img src="https://image.zhui.dev/file/1731155190919_Reef.jpg" /></a></p>

<hr />

<p>Btw, ä¸‹é¢è¿™å¼  Deepin çš„å£çº¸ä¹Ÿéå¸¸å–œæ¬¢ã€‚</p>

<p><a data-fancybox="kde6-wallpapers" href="https://image.zhui.dev/file/1731155071899_desktop.jpg"><img src="https://image.zhui.dev/file/1731155071899_desktop.jpg" /></a></p>]]></content><author><name>Mr. Error è¿½ ğŸ§</name><email>error@zhui.dev</email></author><category term="gallery" /><category term="kde" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">C è¯­è¨€ä¸­çš„ unlikely å’Œ likely</title><link href="https://zhui.dev/2024-02/unlikely-and-likely-in-c.html" rel="alternate" type="text/html" title="C è¯­è¨€ä¸­çš„ unlikely å’Œ likely" /><published>2024-02-29T00:00:00+08:00</published><updated>2024-02-29T00:00:00+08:00</updated><id>https://zhui.dev/2024-02/unlikely-and-likely-in-c</id><content type="html" xml:base="https://zhui.dev/2024-02/unlikely-and-likely-in-c.html"><![CDATA[<p>ä»Šå¤©åœ¨è¿™ä¸ª <a href="https://github.com/firelzrd/bore-scheduler/commit/2dfae364f6d7ae26eca4ddfafb3764f2525bbaa5">commit</a> ä¸­çœ‹åˆ°è¿™æ ·ä¸€æ®µä»£ç ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#ifdef CONFIG_SCHED_BORE
</span>		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">sched_bore</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#endif // CONFIG_SCHED_BORE
</span></code></pre></div></div>

<p>è¿™ä¸ª <code class="language-plaintext highlighter-rouge">unlikely</code> è®©æˆ‘å¾ˆç–‘æƒ‘ï¼Œ<code class="language-plaintext highlighter-rouge">if</code> é‡Œé¢è¿˜èƒ½è¿™æ ·ï¼Ÿç„¶ååœ¨ç½‘ä¸ŠæŸ¥äº†ç›¸å…³èµ„æ–™ï¼Œäº†è§£äº†å…¶ä½œç”¨ã€‚å› ä¸ºè¿™æ®µä»£ç æ˜¯åœ¨<code class="language-plaintext highlighter-rouge">kernel/sched/fair.c</code>ä¸­ï¼Œäºæ˜¯å»ç¿»çœ‹äº† Linux å†…æ ¸æºç ï¼Œå‘ç°å¾ˆå¤š<code class="language-plaintext highlighter-rouge">if</code>å¤„ä½¿ç”¨äº† <code class="language-plaintext highlighter-rouge">unlikely</code>.</p>

<p><code class="language-plaintext highlighter-rouge">likely()</code>å’Œ<code class="language-plaintext highlighter-rouge">unlikely()</code>æ˜¯ä¸€ç§å®ï¼Œå¸®åŠ©ç¼–è¯‘å™¨æ›´å¥½åœ°ä¼˜åŒ–ä»£ç çš„æ‰§è¡Œè·¯å¾„ï¼Œä»¥æé«˜ç¨‹åºçš„æ€§èƒ½ï¼Œ<code class="language-plaintext highlighter-rouge">likely()</code>å®ç”¨äºè¡¨ç¤ºæ¡ä»¶ä¸ºçœŸçš„å¯èƒ½æ€§è¾ƒå¤§ï¼Œè€Œ<code class="language-plaintext highlighter-rouge">unlikely()</code>å®åˆ™ç”¨äºè¡¨ç¤ºæ¡ä»¶ä¸ºå‡çš„å¯èƒ½æ€§è¾ƒå¤§ã€‚</p>

<p>æ¯”å¦‚ä¸€ä¸ªåˆ¤æ–­ç´ æ•°çš„åˆ—å­ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>
<span class="cp">#define likely(x)   __builtin_expect(!!(x), 1)
#define unlikely(x) __builtin_expect(!!(x), 0)
</span>
<span class="kt">int</span> <span class="nf">is_prime</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">*</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">n</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">is_prime</span><span class="p">(</span><span class="n">num</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"%d is likely a prime number</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"%d is unlikely a prime number</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>ç¬¬äºŒåè¡Œé‡Œï¼Œ<code class="language-plaintext highlighter-rouge">unlikely(n % i == 0)</code> è¡¨ç¤ºç¼–è¯‘å™¨åº”è¯¥å°† <code class="language-plaintext highlighter-rouge">n % i == 0</code> è¿™ä¸ªæ¡ä»¶åˆ¤æ–­è§†ä¸ºä¸å¤ªå¯èƒ½å‘ç”Ÿçš„æƒ…å†µã€‚</p>

<p>å¦‚æœæ‡‚æ±‡ç¼–çš„è¯å¯ä»¥ä»æ±‡ç¼–å±‚æŸ¥çœ‹å¯¹åº”å˜åŒ–ã€‚</p>

<p>æ—¢ç„¶çŸ¥é“äº†ä½œç”¨ï¼Œå¯ä¸å¯ä»¥é€šè¿‡ç¨‹åºéªŒè¯æ˜¯å¦æœ‰ä¼˜åŒ–å‘¢ï¼Ÿæ¯”å¦‚é€šè¿‡æ—¶é—´å¤æ‚åº¦é«˜çš„æŸ¥æ‰¾ç®—æ³•åœ¨æ•°æ®çº§å¤§çš„æ ·æœ¬é‡ŒæŸ¥æ‰¾ï¼Œç„¶åæ¯”è¾ƒèŠ±è´¹çš„æ—¶é—´ï¼Œä¸çŸ¥é“è¿™æ ·æ˜¯å¦å¯ä»¥éªŒè¯ã€‚</p>

<p>è¿™æ˜¯ä¸€æ®µæŸ¥æ‰¾ç´ æ•°çš„ä»£ç ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
</span>
<span class="cp">#define MAX_NUMBER 100000000
</span>
<span class="cp">#define likely(x)   __builtin_expect(!!(x), 1)
#define unlikely(x) __builtin_expect(!!(x), 0)
</span>
<span class="kt">void</span> <span class="nf">find_primes_with_unlikely</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">bool</span> <span class="n">is_prime</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">timespec</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">cpu_time_used</span><span class="p">;</span>

    <span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_MONOTONIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">MAX_NUMBER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">is_prime</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span> <span class="o">*</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">is_prime</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_prime</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// printf("%d ", i);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_MONOTONIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">);</span>
    <span class="n">cpu_time_used</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">start</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">+</span> <span class="p">(</span><span class="n">end</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">-</span> <span class="n">start</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Find primes with unlikely execution time: %lf ns</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">cpu_time_used</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">find_primes_without_unlikely</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">bool</span> <span class="n">is_prime</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">timespec</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">cpu_time_used</span><span class="p">;</span>

    <span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_MONOTONIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">MAX_NUMBER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">is_prime</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span> <span class="o">*</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">is_prime</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_prime</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// printf("%d ", i);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_MONOTONIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">);</span>
    <span class="n">cpu_time_used</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">start</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">+</span> <span class="p">(</span><span class="n">end</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">-</span> <span class="n">start</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Find primes without unlikely execution time: %lf ns</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">cpu_time_used</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Starting prime search...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  
    <span class="n">find_primes_with_unlikely</span><span class="p">();</span>

    <span class="n">find_primes_without_unlikely</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>æœ€å¼€å§‹ç”¨<code class="language-plaintext highlighter-rouge">gettimeofday()</code>å‡½æ•°æ¥è·å–æ—¶é—´ä¿¡æ¯ï¼Œå‘ç°å‡ ä¹æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œäºæ˜¯æ¢æˆäº† <code class="language-plaintext highlighter-rouge">clock_gettime()</code> å‡½æ•°æ¥è·å–çº³ç§’çº§åˆ«çš„æ—¶é—´ä¿¡æ¯ã€‚</p>

<p>ä½†æ˜¯å§ï¼Œè¿™ä¸ªæµ‹è¯•ç»“æœä¸å¤ªå¯¹ï¼Œå¤§å¤šæ•°æ—¶å€™æ˜¯ç”¨äº†<code class="language-plaintext highlighter-rouge">unlikely</code>çš„èŠ±è´¹æ›´å¤šæ—¶é—´â€¦æ˜¯å› ä¸ºä¸åº”è¯¥ç”¨è¿™æ ·çš„æ–¹å¼æ¯”è¾ƒï¼Ÿ</p>

<p>æˆ‘åˆå‘ç°äº† C++ ä¹Ÿæœ‰ <code class="language-plaintext highlighter-rouge">[[likely]]</code> <code class="language-plaintext highlighter-rouge">[[unlikely]]</code>ï¼Œå¹¶ä¸” cppreference æœ‰<a href="https://zh.cppreference.com/w/cpp/language/attributes/likely">ç¤ºä¾‹ä»£ç </a>ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;chrono&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cmath&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;iomanip&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;random&gt;</span><span class="cp">
</span> 
<span class="k">namespace</span> <span class="n">with_attributes</span>
<span class="p">{</span>
    <span class="k">constexpr</span> <span class="kt">double</span> <span class="n">pow</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">n</span><span class="p">)</span> <span class="k">noexcept</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">[[</span><span class="n">likely</span><span class="p">]]</span>
            <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">else</span> <span class="p">[[</span><span class="n">unlikely</span><span class="p">]]</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">constexpr</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">fact</span><span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="n">n</span><span class="p">)</span> <span class="k">noexcept</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">[[</span><span class="n">likely</span><span class="p">]]</span>
            <span class="k">return</span> <span class="n">n</span> <span class="o">*</span> <span class="n">fact</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">else</span> <span class="p">[[</span><span class="n">unlikely</span><span class="p">]]</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">constexpr</span> <span class="kt">double</span> <span class="n">cos</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">)</span> <span class="k">noexcept</span>
    <span class="p">{</span>
        <span class="k">constexpr</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">precision</span><span class="p">{</span><span class="mi">16LL</span><span class="p">};</span>
        <span class="kt">double</span> <span class="n">y</span><span class="p">{};</span>
        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">n</span><span class="p">{</span><span class="mi">0LL</span><span class="p">};</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">precision</span><span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">2LL</span><span class="p">)</span> <span class="p">[[</span><span class="n">likely</span><span class="p">]]</span>
            <span class="n">y</span> <span class="o">+=</span> <span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mi">2LL</span> <span class="o">?</span> <span class="o">-</span><span class="n">fact</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">:</span> <span class="n">fact</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">y</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="c1">// namespace with_attributes</span>
 
<span class="k">namespace</span> <span class="n">no_attributes</span>
<span class="p">{</span>
    <span class="k">constexpr</span> <span class="kt">double</span> <span class="n">pow</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">n</span><span class="p">)</span> <span class="k">noexcept</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">constexpr</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">fact</span><span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="n">n</span><span class="p">)</span> <span class="k">noexcept</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">n</span> <span class="o">*</span> <span class="n">fact</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">constexpr</span> <span class="kt">double</span> <span class="n">cos</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">)</span> <span class="k">noexcept</span>
    <span class="p">{</span>
        <span class="k">constexpr</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">precision</span><span class="p">{</span><span class="mi">16LL</span><span class="p">};</span>
        <span class="kt">double</span> <span class="n">y</span><span class="p">{};</span>
        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">n</span><span class="p">{</span><span class="mi">0LL</span><span class="p">};</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">precision</span><span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">2LL</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">+=</span> <span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mi">2LL</span> <span class="o">?</span> <span class="o">-</span><span class="n">fact</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">:</span> <span class="n">fact</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">y</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="c1">// namespace no_attributes</span>
 
<span class="kt">double</span> <span class="n">gen_random</span><span class="p">()</span> <span class="k">noexcept</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">random_device</span> <span class="n">rd</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">mt19937</span> <span class="n">gen</span><span class="p">(</span><span class="n">rd</span><span class="p">());</span>
    <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">uniform_real_distribution</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">dis</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">dis</span><span class="p">(</span><span class="n">gen</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="k">volatile</span> <span class="kt">double</span> <span class="n">sink</span><span class="p">{};</span> <span class="c1">// ç¡®ä¿æœ‰å‰¯ä½œç”¨</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="n">x</span> <span class="o">:</span> <span class="p">{</span><span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)})</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span>
            <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">setprecision</span><span class="p">(</span><span class="mi">53</span><span class="p">)</span>
            <span class="o">&lt;&lt;</span> <span class="s">"x = "</span> <span class="o">&lt;&lt;</span> <span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span>
            <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span>
            <span class="o">&lt;&lt;</span> <span class="n">with_attributes</span><span class="o">::</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span>
            <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">with_attributes</span><span class="o">::</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">?</span> <span class="s">"equal"</span> <span class="o">:</span> <span class="s">"differ"</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span><span class="p">;</span>
 
    <span class="k">auto</span> <span class="n">benchmark</span> <span class="o">=</span> <span class="p">[](</span><span class="k">auto</span> <span class="n">fun</span><span class="p">,</span> <span class="k">auto</span> <span class="n">rem</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="k">auto</span> <span class="n">start</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">size</span><span class="p">{</span><span class="mi">1ULL</span><span class="p">};</span> <span class="n">size</span> <span class="o">!=</span> <span class="mi">10'000'000ULL</span><span class="p">;</span> <span class="o">++</span><span class="n">size</span><span class="p">)</span>
            <span class="n">sink</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">gen_random</span><span class="p">());</span>
        <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">diff</span> <span class="o">=</span>
            <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Time: "</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">fixed</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">setprecision</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">diff</span><span class="p">.</span><span class="n">count</span><span class="p">()</span>
                  <span class="o">&lt;&lt;</span> <span class="s">" sec "</span> <span class="o">&lt;&lt;</span> <span class="n">rem</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> 
    <span class="p">};</span>
 
    <span class="n">benchmark</span><span class="p">(</span><span class="n">with_attributes</span><span class="o">::</span><span class="n">cos</span><span class="p">,</span> <span class="s">"(with attributes)"</span><span class="p">);</span>
    <span class="n">benchmark</span><span class="p">(</span><span class="n">no_attributes</span><span class="o">::</span><span class="n">cos</span><span class="p">,</span> <span class="s">"(without attributes)"</span><span class="p">);</span>
    <span class="n">benchmark</span><span class="p">([](</span><span class="kt">double</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span><span class="p">);</span> <span class="p">},</span> <span class="s">"(std::cos)"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä½†æ˜¯æµ‹å‡ºæ¥å¤§å¤šæ•°æ—¶å€™ä¹Ÿæ˜¯ <code class="language-plaintext highlighter-rouge">with_attributes</code> æ›´è€—æ—¶ã€‚ä¹Ÿè®¸éœ€è¦æ›´ä¸“ä¸šçš„å·¥å…·é…åˆæ­£ç¡®çš„åœºæ™¯æ¥è¿›è¡Œæµ‹è¯•ã€‚</p>

<p>å‚è€ƒèµ„æ–™ï¼š</p>

<ol>
  <li><a href="https://www.geeksforgeeks.org/branch-prediction-macros-in-gcc/">https://www.geeksforgeeks.org/branch-prediction-macros-in-gcc/</a></li>
  <li><a href="https://stackoverflow.com/questions/109710/how-do-the-likely-unlikely-macros-in-the-linux-kernel-work-and-what-is-their-ben">https://stackoverflow.com/questions/109710/how-do-the-likely-unlikely-macros-in-the-linux-kernel-work-and-what-is-their-ben</a></li>
  <li><a href="https://zh.cppreference.com/w/cpp/language/attributes/likely">https://zh.cppreference.com/w/cpp/language/attributes/likely</a></li>
</ol>]]></content><author><name>Mr. Error è¿½ ğŸ§</name><email>error@zhui.dev</email></author><category term="code" /><summary type="html"><![CDATA[ä»Šå¤©åœ¨è¿™ä¸ª commit ä¸­çœ‹åˆ°è¿™æ ·ä¸€æ®µä»£ç ï¼š]]></summary></entry><entry><title type="html">å°ç±³ç¤¾åŒºè‡ªåŠ¨ç­¾åˆ°/ä»»åŠ¡</title><link href="https://zhui.dev/2023-11/xiaomi-cn-auto-tasks.html" rel="alternate" type="text/html" title="å°ç±³ç¤¾åŒºè‡ªåŠ¨ç­¾åˆ°/ä»»åŠ¡" /><published>2023-11-08T00:00:00+08:00</published><updated>2023-11-08T00:00:00+08:00</updated><id>https://zhui.dev/2023-11/xiaomi-cn-auto-tasks</id><content type="html" xml:base="https://zhui.dev/2023-11/xiaomi-cn-auto-tasks.html"><![CDATA[<p>ä»Šå¤©<a href="https://www.xiaomi.cn/">å°ç±³ç¤¾åŒº</a>å¯¹ Bootloader è§£é”æƒé™å‘å¸ƒäº†å…¬å‘Šï¼Œè¦æ±‚ï¼š</p>

<ol>
  <li>é€šè¿‡ã€Šè§£é”èµ„æ ¼ç­”é¢˜æµ‹è¯•ã€‹</li>
  <li>ç¤¾åŒºæˆé•¿ç­‰çº§è¾¾åˆ° 5 æ®µ</li>
  <li>å®Œæˆå®åè®¤è¯</li>
</ol>

<p>æ‰èƒ½ç”³è¯·è§£é”ï¼Œç”³è¯·ä¸€æ¬¡æœ‰æ•ˆæœŸåªæœ‰ä¸€å¹´ï¼Œæ¯å¹´æœ€å¤šæ”¯æŒä¸‰å°è®¾å¤‡è§£é”ï¼Œè§£é”ç­‰å¾…æœŸä¸º 72 å°æ—¶ã€‚</p>

<p>è¯•ç€å»ç­”äº†ä¸€ä¸‹ã€Šè§£é”èµ„æ ¼ç­”é¢˜æµ‹è¯•ã€‹ï¼Œå¾ˆç®€å•ï¼Œ90 å¤šåˆ†ï¼Œéƒ½æ˜¯ä¸€äº›å¸¸è¯†å’Œå¸¸ç”¨å‘½ä»¤ï¼Œä½†æ˜¯æˆ‘ç¤¾åŒºç­‰çº§æ‰ 2 çº§ï¼Œå°ç±³ç¤¾åŒºå‡çº§å¤ªæ…¢äº†ï¼Œåˆç»å¸¸å¿˜è®°ç­¾åˆ°åšä»»åŠ¡ï¼Œäºæ˜¯æ‰¾åˆ°äº† <a href="https://github.com/0-8-4/miui-auto-tasks">miui-auto-tasks</a> - ä¸€ä¸ªè‡ªåŠ¨åŒ–å®Œæˆå°ç±³ç¤¾åŒºä»»åŠ¡çš„è„šæœ¬ã€‚ç…§ç€å®ƒçš„ <a href="https://github.com/0-8-4/miui-auto-tasks/wiki">wiki</a> é…ç½®ï¼ŒåŠŸèƒ½å…¨å¼€ï¼ˆ<del>ç”¨å°±ä¸è¦æ€•</del>ï¼‰</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">accounts</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">uid</span><span class="pi">:</span> <span class="s">xxxxxxxxx</span>
    <span class="c1"># è´¦æˆ· ID éè´¦æˆ·ç”¨æˆ·åæˆ–æ‰‹æœºå·</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">xxxxxxxxxxxxxxxxxxxxxxxxx</span>
    <span class="c1"># è´¦æˆ·å¯†ç æˆ–å…¶ MD5 å“ˆå¸Œ</span>
    <span class="na">user-agent</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Mozilla/5.0</span><span class="nv"> </span><span class="s">(X11;</span><span class="nv"> </span><span class="s">Linux</span><span class="nv"> </span><span class="s">x86_64;</span><span class="nv"> </span><span class="s">rv:121.0)</span><span class="nv"> </span><span class="s">Gecko/20100101</span><span class="nv"> </span><span class="s">Firefox/121.0'</span>
    <span class="c1"># ç™»å½•ç¤¾åŒºæ—¶æ‰€ç”¨æµè§ˆå™¨çš„ User-Agent</span>
    <span class="c1"># å¯åœ¨æ­¤å·¥å…·æŸ¥çœ‹ï¼šhttps://tool.chinaz.com/useragent</span>
    
    <span class="c1"># åŠŸèƒ½å¼€å…³</span>
    <span class="na">check-in</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="c1"># ç¤¾åŒºæˆé•¿å€¼ç­¾åˆ°ï¼Œå¯ç”¨åŠŸèƒ½æ„å‘³ç€ä½ æ„¿æ„è‡ªè¡Œæ‰¿æ‹…ç›¸å…³é£é™©</span>
    <span class="na">browse-user-page</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="c1"># ç¤¾åŒºæµè§ˆä¸ªäººä¸»é¡µ 10 ç§’ï¼Œå¯ç”¨åŠŸèƒ½æ„å‘³ç€ä½ æ„¿æ„è‡ªè¡Œæ‰¿æ‹…ç›¸å…³é£é™©</span>
    <span class="na">browse-post</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="c1"># ç¤¾åŒºæµè§ˆå¸–å­ 10 ç§’ï¼Œå¯ç”¨åŠŸèƒ½æ„å‘³ç€ä½ æ„¿æ„è‡ªè¡Œæ‰¿æ‹…ç›¸å…³é£é™©</span>
    <span class="na">thumb-up</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="c1"># ç‚¹èµå¸–å­ï¼Œå¯ç”¨åŠŸèƒ½æ„å‘³ç€ä½ æ„¿æ„è‡ªè¡Œæ‰¿æ‹…ç›¸å…³é£é™©</span>
    <span class="na">browse-specialpage</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="c1"># ç¤¾åŒºåœ¨æ´»åŠ¨æœŸé—´å¯èƒ½ä¼šå‡ºç°é™æ—¶çš„â€œæµè§ˆæŒ‡å®šä¸“é¢˜é¡µâ€ä»»åŠ¡ï¼Œå¯ç”¨åŠŸèƒ½æ„å‘³ç€ä½ æ„¿æ„è‡ªè¡Œæ‰¿æ‹…ç›¸å…³é£é™©</span>
    <span class="na">board-follow</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="c1"># ç¤¾åŒºå¯èƒ½ä¼šå‡ºç°é™æ—¶çš„â€œåŠ å…¥åœˆå­â€ä»»åŠ¡ï¼Œå¯ç”¨åŠŸèƒ½æ„å‘³ç€ä½ æ„¿æ„è‡ªè¡Œæ‰¿æ‹…ç›¸å…³é£é™©</span>
    <span class="na">carrot-pull</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="c1"># ç¤¾åŒºæ‹”èåœï¼Œå¯ç”¨åŠŸèƒ½æ„å‘³ç€ä½ æ„¿æ„è‡ªè¡Œæ‰¿æ‹…ç›¸å…³é£é™©</span>

<span class="na">logging</span><span class="pi">:</span> <span class="kc">false</span>
<span class="c1"># å½’æ¡£æ—¥å¿—åˆ°æœ¬åœ°æ–‡ä»¶</span>
<span class="na">version</span><span class="pi">:</span> <span class="s">v1.6.0</span>
<span class="c1"># config æ–‡ä»¶ç‰ˆæœ¬å·ï¼Œdebug ç”¨</span>

</code></pre></div></div>

<p>ç”¨ systemd timer è®©å®ƒæ¯å¤©æ‰§è¡Œï¼Œå…ˆåœ¨ <code class="language-plaintext highlighter-rouge">/etc/systemd/user/</code> åˆ›å»ºä¸€ä¸ª [Service] æ‰§è¡Œ python ç¨‹åºï¼Œ</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>MIUI Auto Tasks

<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>oneshot
<span class="nv">ExecStart</span><span class="o">=</span>%h/venv/bin/python %h/pytools/miui-auto-tasks/miuitask.py
</code></pre></div></div>

<p>å†åˆ›å»ºä¸€ä¸ª [Timer] å®šæ—¶æ‰§è¡Œï¼Œ</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Run MIUI Auto Tasks Every Day

<span class="o">[</span>Timer]
<span class="nv">OnBootSec</span><span class="o">=</span>3min
<span class="nv">OnCalendar</span><span class="o">=</span><span class="k">*</span>-<span class="k">*</span>-<span class="k">*</span> 12:00:00
<span class="nv">RandomizedDelaySec</span><span class="o">=</span>10min
<span class="nv">Persistent</span><span class="o">=</span><span class="nb">true
</span><span class="nv">Unit</span><span class="o">=</span>miui-auto-tasks.service

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>timers.target
</code></pre></div></div>

<p>ç”¨ <code class="language-plaintext highlighter-rouge">systemctl --user enable --now</code> è·‘èµ·æ¥ï¼Œæ ¹æ®æˆ‘ä½¿ç”¨ç”µè„‘çš„ä¹ æƒ¯ï¼Œåº”è¯¥æ¯å¤©éƒ½èƒ½è·‘ä¸€éã€‚</p>

<p>å‚è€ƒèµ„æ–™ï¼š</p>

<ol>
  <li><a href="https://wiki.archlinux.org/title/Systemd">https://wiki.archlinux.org/title/Systemd</a></li>
  <li><a href="https://wiki.archlinux.org/title/Systemd/Timers">https://wiki.archlinux.org/title/Systemd/Timers</a></li>
</ol>]]></content><author><name>Mr. Error è¿½ ğŸ§</name><email>error@zhui.dev</email></author><category term="misc" /><summary type="html"><![CDATA[ä»Šå¤©å°ç±³ç¤¾åŒºå¯¹ Bootloader è§£é”æƒé™å‘å¸ƒäº†å…¬å‘Šï¼Œè¦æ±‚ï¼š]]></summary></entry></feed>